<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM - –£—á–µ—Ç —Å–¥–µ–ª–æ–∫</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #f5f7fa;
            color: #1a1a2e;
            min-height: 100vh;
        }
        
        /* Navigation */
        /* Global Top Navigation */
        .top-nav {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 0.75rem 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }
        .top-nav a {
            color: white;
            text-decoration: none;
            padding: 0.6rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s;
            background: rgba(255,255,255,0.15);
        }
        .top-nav a:hover {
            background: rgba(255,255,255,0.3);
        }
        .top-nav a.active {
            background: white;
            color: #667eea;
        }

        .nav {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-logo {
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .nav-tabs {
            display: flex;
            gap: 0.5rem;
        }
        
        .nav-tab {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .nav-tab:hover, .nav-tab.active {
            background: white;
            color: #667eea;
        }
        
        /* Main container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Sections */
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #333;
        }
        
        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .stat-card.warning {
            border-left: 4px solid #f59e0b;
        }
        
        .stat-card.warning .stat-value {
            color: #f59e0b;
        }
        
        .stat-card.success {
            border-left: 4px solid #10b981;
        }
        
        .stat-card.success .stat-value {
            color: #10b981;
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
            font-size: 0.85rem;
            text-transform: uppercase;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        /* Status badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .badge-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-completed {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-verified {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .badge-cancelled {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        select.form-control {
            cursor: pointer;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #d1d5db;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-info {
            background: #3b82f6;
            color: white;
        }
        
        .btn-info:hover {
            background: #2563eb;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }
        
        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }
        
        /* Cash batches */
        .batch-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .batch-info h4 {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }
        
        .batch-info p {
            color: #666;
            font-size: 0.85rem;
        }
        
        .batch-amount {
            text-align: right;
        }
        
        .batch-amount .thb {
            font-size: 1.25rem;
            font-weight: 600;
            color: #10b981;
        }
        
        .batch-amount .rate {
            font-size: 0.85rem;
            color: #666;
        }
        
        /* Progress bar */
        .progress {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }
        
        /* Transactions list */
        .tx-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tx-item:hover {
            background: #e5e7eb;
        }
        
        .tx-item.used {
            opacity: 0.5;
        }
        
        .tx-amount {
            font-size: 1.1rem;
            font-weight: 600;
            color: #10b981;
        }
        
        .tx-hash {
            font-family: monospace;
            font-size: 0.8rem;
            color: #666;
        }
        
        .tx-time {
            font-size: 0.85rem;
            color: #888;
        }
        
        /* Alert boxes */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .alert-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }
        
        .alert-success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            color: #065f46;
        }
        
        .alert-error {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            color: #991b1b;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .nav {
                flex-direction: column;
                gap: 1rem;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .container {
                padding: 1rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        .balance-subtab-btn.active {
            background: #667eea;
            color: white;
        }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-danger { background: #fee2e2; color: #b91c1c; }
    </style>
</head>
<body>
    <!-- Global Navigation -->
    <nav class="top-nav">
        <a href="/">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</a>
        <a href="/crm" class="active">üìä CRM</a>
    </nav>

    <!-- CRM Navigation -->
    <nav class="nav">
        <div class="nav-logo">CRM –°–¥–µ–ª–æ–∫</div>
        <div class="nav-tabs">
            <button class="nav-tab active" data-section="dashboard">–î–∞—à–±–æ—Ä–¥</button>
            <button class="nav-tab" data-section="deals">–°–¥–µ–ª–∫–∏</button>
            <button class="nav-tab" data-section="create">+ –°–æ–∑–¥–∞—Ç—å</button>
            <button class="nav-tab" data-section="balance">–ë–∞–ª–∞–Ω—Å</button>
            <button class="nav-tab" data-section="reimbursements">–í–æ–∑–º–µ—â–µ–Ω–∏—è</button>
            <button class="nav-tab" data-section="transactions">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</button>
            <button class="nav-tab" data-section="managers">–ú–µ–Ω–µ–¥–∂–µ—Ä—ã</button>
            <button class="nav-tab" data-section="verification">–°–≤–µ—Ä–∫–∞</button>
        </div>
    </nav>
    
    <div class="container">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be loaded here -->
            </div>
            
            <div class="card">
                <div class="card-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–¥–µ–ª–∫–∏</div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–ö–ª–∏–µ–Ω—Ç</th>
                                <th>Pay-In</th>
                                <th>Pay-Out</th>
                                <th>–ü—Ä–∏–±—ã–ª—å</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                            </tr>
                        </thead>
                        <tbody id="recentDealsTable">
                            <!-- Deals will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="attentionAlerts">
                <!-- Alerts will be loaded here -->
            </div>
        </section>
        
        <!-- Deals Section -->
        <section id="deals" class="section">
            <div class="card">
                <div class="card-title">–§–∏–ª—å—Ç—Ä—ã</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                        <select class="form-control" id="filterStatus">
                            <option value="">–í—Å–µ</option>
                            <option value="pending">–û–∂–∏–¥–∞–µ—Ç</option>
                            <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
                            <option value="verified">–ü—Ä–æ–≤–µ—Ä–µ–Ω–∞</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ú–µ–Ω–µ–¥–∂–µ—Ä</label>
                        <input type="text" class="form-control" id="filterManager" placeholder="–ò–º—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–î–∞—Ç–∞ –æ—Ç</label>
                        <input type="date" class="form-control" id="filterDateFrom">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–î–∞—Ç–∞ –¥–æ</label>
                        <input type="date" class="form-control" id="filterDateTo">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="loadDeals()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
            
            <div class="card">
                <div class="card-title">–°–ø–∏—Å–æ–∫ —Å–¥–µ–ª–æ–∫</div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
                                <th>–ö–ª–∏–µ–Ω—Ç</th>
                                <th>–ú–µ—Ç–æ–¥ Pay-In</th>
                                <th>–°—É–º–º–∞ USDT</th>
                                <th>Pay-Out THB</th>
                                <th>–ü—Ä–∏–±—ã–ª—å</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="dealsTable">
                            <!-- Deals will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <!-- Create Deal Section -->
        <section id="create" class="section">
            <div class="card">
                <div class="card-title">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–¥–µ–ª–∫—É</div>
                
                <form id="createDealForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–ú–µ–Ω–µ–¥–∂–µ—Ä</label>
                            <select class="form-control" name="manager_name" id="managerSelect" required>
                                <!-- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ö–ª–∏–µ–Ω—Ç</label>
                            <select class="form-control" name="client_id" id="clientSelect">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–∏–∂–µ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ò–ª–∏ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
                            <input type="text" class="form-control" name="client_name" placeholder="–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç">
                        </div>
                    </div>
                    
                    <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #eee;">
                    
                    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∫–∞—Å—Ç–æ–º–Ω–æ–π —Å–¥–µ–ª–∫–∏ -->
                    <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f0f9ff; border-radius: 8px; border: 1px solid #bae6fd;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="customDealToggle" onchange="toggleCustomDeal()">
                            <strong>–ö–∞—Å—Ç–æ–º–Ω–∞—è —Å–¥–µ–ª–∫–∞</strong>
                            <span style="color: #666; font-size: 0.85rem;">(–Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –≤–∞–ª—é—Ç—ã: THB‚ÜíUSDT, USD –Ω–∞–ª–∏—á–Ω—ã–µ –∏ –¥—Ä.)</span>
                        </label>
                    </div>
                    
                    <!-- –ö–∞—Å—Ç–æ–º–Ω–∞—è —Å–¥–µ–ª–∫–∞ - —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
                    <div id="customDealSection" style="display: none; padding: 1rem; background: #fffbeb; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 1rem; color: #92400e;">–ö–∞—Å—Ç–æ–º–Ω–∞—è —Å–¥–µ–ª–∫–∞ (–ª—é–±—ã–µ –≤–∞–ª—é—Ç—ã)</h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Pay-In: –°—É–º–º–∞</label>
                                <input type="number" class="form-control" id="customPayinAmount" placeholder="1000" step="0.01" oninput="calcCustomProfit()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">–í–∞–ª—é—Ç–∞</label>
                                <select class="form-control" id="customPayinCurrency" onchange="calcCustomProfit()">
                                    <option value="RUB">RUB (—Ä—É–±–ª–∏)</option>
                                    <option value="USDT" selected>USDT</option>
                                    <option value="THB">THB (–±–∞—Ç—ã)</option>
                                    <option value="USD">USD (–Ω–∞–ª–∏—á–Ω—ã–µ)</option>
                                </select>
                            </div>
                            <div class="form-group" id="customPayinRateGroup">
                                <label class="form-label">–ö—É—Ä—Å –∫ USDT</label>
                                <input type="number" class="form-control" id="customPayinRate" placeholder="92.5" step="0.0001" oninput="calcCustomProfit()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">= USDT</label>
                                <input type="text" class="form-control" id="customPayinUsdt" readonly style="background: #e0f2fe; font-weight: 600;">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Pay-Out: –°—É–º–º–∞</label>
                                <input type="number" class="form-control" id="customPayoutAmount" placeholder="35000" step="0.01" oninput="calcCustomProfit()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">–í–∞–ª—é—Ç–∞</label>
                                <select class="form-control" id="customPayoutCurrency" onchange="calcCustomProfit()">
                                    <option value="THB" selected>THB (–±–∞—Ç—ã)</option>
                                    <option value="USDT">USDT</option>
                                    <option value="RUB">RUB (—Ä—É–±–ª–∏)</option>
                                    <option value="USD">USD (–Ω–∞–ª–∏—á–Ω—ã–µ)</option>
                                </select>
                            </div>
                            <div class="form-group" id="customPayoutRateGroup">
                                <label class="form-label">–ö—É—Ä—Å –∫ USDT</label>
                                <input type="number" class="form-control" id="customPayoutRate" placeholder="35.5" step="0.0001" oninput="calcCustomProfit()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">= USDT</label>
                                <input type="text" class="form-control" id="customPayoutUsdt" readonly style="background: #fee2e2; font-weight: 600;">
                            </div>
                        </div>
                        
                        <div class="form-row" style="margin-top: 1rem; padding: 0.75rem; background: #f0fdf4; border-radius: 8px; border: 1px solid #bbf7d0;">
                            <div class="form-group">
                                <label class="form-label">–ü–∞—Ä—Ç–Ω—ë—Ä (—Ä–µ—Ñ–µ—Ä–µ—Ä)</label>
                                <input type="text" class="form-control" id="customReferrerName" placeholder="–ò–º—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞" oninput="calcCustomProfit()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">% –ø–∞—Ä—Ç–Ω—ë—Ä–∞</label>
                                <input type="number" class="form-control" id="customReferrerPercent" placeholder="0" step="0.1" min="0" max="100" oninput="calcCustomProfit()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">–í—ã–ø–ª–∞—Ç–∞ –ø–∞—Ä—Ç–Ω—ë—Ä—É</label>
                                <input type="text" class="form-control" id="customReferrerPayout" readonly style="background: #fef3c7;">
                            </div>
                        </div>
                        
                        <div class="form-row" style="margin-top: 1rem; padding: 0.75rem; background: white; border-radius: 8px;">
                            <div class="form-group">
                                <label class="form-label">–í–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å</label>
                                <input type="text" class="form-control" id="customProfitUsdt" readonly style="font-weight: 600;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</label>
                                <input type="text" class="form-control" id="customNetProfit" readonly style="font-weight: 600; font-size: 1.1rem;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">–ú–µ—Ç–æ–¥ –≤—ã–¥–∞—á–∏</label>
                                <select class="form-control" id="customPayoutMethod">
                                    <option value="office">–û—Ñ–∏—Å</option>
                                    <option value="courier">–ö—É—Ä—å–µ—Ä</option>
                                    <option value="atm">–ë–∞–Ω–∫–æ–º–∞—Ç</option>
                                    <option value="transfer">–ü–µ—Ä–µ–≤–æ–¥</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">–î–∞—Ç–∞ —Å–¥–µ–ª–∫–∏</label>
                                <input type="date" class="form-control" id="customDealDate">
                                <small style="color: #666;">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">–ó–∞–º–µ—Ç–∫–∏</label>
                                <input type="text" class="form-control" id="customNotes" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏...">
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-success" style="margin-top: 1rem;" onclick="createCustomDeal()">
                            –°–æ–∑–¥–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—É—é —Å–¥–µ–ª–∫—É
                        </button>
                    </div>
                    
                    <!-- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
                    <div id="standardDealSection">
                    <h3 style="margin-bottom: 1rem; color: #10b981;">Pay-In (–ü–æ–ª—É—á–µ–Ω–∏–µ)</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–ú–µ—Ç–æ–¥ Pay-In</label>
                            <select class="form-control" name="payin_method" id="payinMethod" required>
                                <option value="spp_doverka">–°–ë–ü / –î–æ–≤–µ—Ä–∫–∞</option>
                                <option value="partners_cash">–ü–∞—Ä—Ç–Ω–µ—Ä—ã (–Ω–∞–ª–∏—á–Ω—ã–µ)</option>
                                <option value="crypto_direct">–ö—Ä–∏–ø—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é</option>
                            </select>
                        </div>
                        <div class="form-group" id="payinRubGroup">
                            <label class="form-label">–°—É–º–º–∞ RUB</label>
                            <input type="number" class="form-control" name="payin_amount_rub" placeholder="100000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–°—É–º–º–∞ USDT</label>
                            <input type="number" class="form-control" name="payin_amount_usdt" placeholder="1000" step="0.01">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" id="payinPartnerGroup" style="display:none;">
                            <label class="form-label">–ü–∞—Ä—Ç–Ω–µ—Ä (–∫—Ç–æ –ø—Ä–∏—Å–ª–∞–ª)</label>
                            <input type="text" class="form-control" name="payin_partner_name" placeholder="–ò–º—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞">
                        </div>
                        <div class="form-group" id="payinTxHashGroup">
                            <label class="form-label">–•—ç—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–¥–ª—è –∫—Ä–∏–ø—Ç—ã)</label>
                            <select class="form-control" id="payinTxSelect" onchange="selectPayinTx(this)" style="margin-bottom: 0.5rem;">
                                <option value="">-- –í—ã–±—Ä–∞—Ç—å –∏–∑ –≤—Ö–æ–¥—è—â–∏—Ö --</option>
                            </select>
                            <input type="text" class="form-control" name="payin_tx_hash" placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ TxHash –≤—Ä—É—á–Ω—É—é...">
                        </div>
                        <div class="form-group" id="payinRateGroup">
                            <label class="form-label">–ö—É—Ä—Å RUB/USDT</label>
                            <input type="number" class="form-control" name="payin_rate_rub_usdt" placeholder="92.5" step="0.01">
                        </div>
                    </div>
                    
                    <div class="form-row" id="doverkaGroup" style="display:none;">
                        <div class="form-group">
                            <label class="form-label">ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –î–æ–≤–µ—Ä–∫–∏</label>
                            <input type="text" class="form-control" name="doverka_transaction_id" placeholder="47871">
                        </div>
                    </div>
                    
                    <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #eee;">
                    
                    <h3 style="margin-bottom: 1rem; color: #ef4444;">Pay-Out (–í—ã–¥–∞—á–∞)</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–ú–µ—Ç–æ–¥ –≤—ã–¥–∞—á–∏</label>
                            <select class="form-control" name="payout_method">
                                <option value="office">–û—Ñ–∏—Å</option>
                                <option value="courier">–ö—É—Ä—å–µ—Ä</option>
                                <option value="atm">–ë–∞–Ω–∫–æ–º–∞—Ç</option>
                                <option value="transfer">–ü–µ—Ä–µ–≤–æ–¥</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫</label>
                            <select class="form-control" name="payout_source" id="payoutSource">
                                <option value="cash_batch">–ò–∑ –∫–∞—Å—Å—ã (–Ω–∞–ª–∏—á–Ω—ã–µ)</option>
                                <option value="bank_card">–° –∫–∞—Ä—Ç—ã –±–∞–Ω–∫–∞</option>
                                <option value="binance">Binance</option>
                                <option value="founder_personal">–õ–∏—á–Ω—ã–µ —Ñ–∞—É–Ω–¥–µ—Ä–∞</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–°—É–º–º–∞ THB</label>
                            <input type="number" class="form-control" name="payout_amount_thb" placeholder="50000" id="payoutAmountThb" step="0.01">
                        </div>
                    </div>
                    
                    <div class="form-row" id="cashBatchGroup">
                        <div class="form-group">
                            <label class="form-label">–ö–∞—Å—Å–∞ (FIFO –∞–≤—Ç–æ-—Å–ø–∏—Å–∞–Ω–∏–µ)</label>
                            <div id="cashBalanceInfo" style="padding: 0.5rem; background: #f0fdf4; border-radius: 6px; font-size: 0.9rem;">
                                –ó–∞–≥—Ä—É–∑–∫–∞...
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å USDT</label>
                            <input type="text" class="form-control" id="cashBatchCostUsdt" readonly placeholder="–ê–≤—Ç–æ">
                        </div>
                    </div>
                    
                    <div class="form-row" id="bankCardGroup" style="display:none;">
                        <div class="form-group">
                            <label class="form-label">–ö–∞—Ä—Ç–∞ –±–∞–Ω–∫–∞</label>
                            <select class="form-control" name="bank_card_id" id="bankCardSelect">
                                <!-- Options loaded dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–û—Å—Ç–∞—Ç–æ–∫ / –ö—É—Ä—Å</label>
                            <input type="text" class="form-control" id="bankCardInfo" readonly placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É">
                        </div>
                    </div>
                    
                    <div class="form-row" id="binanceGroup" style="display:none;">
                        <div class="form-group">
                            <label class="form-label">–ö–æ—à–µ–ª–µ–∫ —Å–ø–∏—Å–∞–Ω–∏—è</label>
                            <select class="form-control" name="payout_wallet_id" id="payoutWalletSelect">
                                <!-- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–•—ç—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–∏—Å—Ö–æ–¥—è—â–∏–µ)</label>
                            <select class="form-control" id="binanceTxSelect" onchange="selectBinanceTx()">
                                <option value="">-- –í—ã–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞ --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Ö—ç—à</label>
                            <input type="text" class="form-control" name="payout_tx_hash" id="binanceTxInput" placeholder="TxHash...">
                        </div>
                    </div>
                    <div class="form-row" id="binanceGroup2" style="display:none;">
                        <div class="form-group">
                            <label class="form-label">USDT –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ *</label>
                            <input type="number" class="form-control" name="payout_amount_usdt" id="binanceUsdt" placeholder="–°–∫–æ–ª—å–∫–æ USDT –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏" step="0.01" oninput="calcBinanceRate()">
                            <small style="color: #666;">–°–∫–æ–ª—å–∫–æ USDT –∏–∑ —ç—Ç–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–∞ —Å–¥–µ–ª–∫—É</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ö—É—Ä—Å THB/USDT (–∞–≤—Ç–æ)</label>
                            <input type="text" class="form-control" id="binanceRate" name="payout_rate" readonly style="background: #e0f2fe; font-weight: 600;">
                        </div>
                    </div>
                    
                    <div class="form-row" id="founderGroup" style="display:none;">
                        <div class="form-group">
                            <label class="form-label">–§–∞—É–Ω–¥–µ—Ä (–∫—Ç–æ –æ–ø–ª–∞—Ç–∏–ª)</label>
                            <select class="form-control" name="payout_founder_name">
                                <option value="–ê–Ω–¥—Ä–µ–π">–ê–Ω–¥—Ä–µ–π</option>
                                <option value="–¢–µ–æ–¥–æ—Ä">–¢–µ–æ–¥–æ—Ä</option>
                            </select>
                        </div>
                        <div class="form-group" style="grid-column: span 2;">
                            <label class="form-label">–ü—Ä–∏–±—ã–ª—å</label>
                            <div style="padding: 0.75rem; background: #fef3c7; border-radius: 8px; color: #92400e; font-size: 0.9rem;">
                                <strong>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞ –¥–æ –≤–æ–∑–º–µ—â–µ–Ω–∏—è.</strong><br>
                                <small>–ö—É—Ä—Å —Å—Ç–∞–Ω–µ—Ç –∏–∑–≤–µ—Å—Ç–µ–Ω –∫–æ–≥–¥–∞ –≤–µ—Ä–Ω—ë–º –¥–µ–Ω—å–≥–∏ —Ñ–∞—É–Ω–¥–µ—Ä—É. –°–æ–∑–¥–∞–π—Ç–µ –≤–æ–∑–º–µ—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–¥–µ–ª–∫–∏.</small>
                            </div>
                        </div>
                    </div>
                    
                    <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #eee;">
                    
                    <h3 style="margin-bottom: 1rem; color: #f59e0b;">–ü–∞—Ä—Ç–Ω–µ—Ä-—Ä–µ—Ñ–µ—Ä–µ—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</h3>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">–ï—Å–ª–∏ –ø–∞—Ä—Ç–Ω–µ—Ä –ø–æ–º–æ–≥ —Å–æ —Å–¥–µ–ª–∫–æ–π –∏ –ø–æ–ª—É—á–∞–µ—Ç —á–∞—Å—Ç—å –ø—Ä–∏–±—ã–ª–∏</p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–ò–º—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞</label>
                            <input type="text" class="form-control" name="referrer_name" placeholder="–ò–º—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞">
                        </div>
                        <div class="form-group">
                            <label class="form-label">% –æ—Ç –ø—Ä–∏–±—ã–ª–∏</label>
                            <input type="number" class="form-control" name="referrer_percent" placeholder="10" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ò–ª–∏ —Ñ–∏–∫—Å. —Å—É–º–º–∞ USDT</label>
                            <input type="number" class="form-control" name="referrer_fixed_usdt" placeholder="50" step="0.01">
                        </div>
                    </div>
                    
                    <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #eee;">
                    
                    <h3 style="margin-bottom: 1rem; color: #667eea;">–†–∞—Å—á–µ—Ç –ø—Ä–∏–±—ã–ª–∏</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–ü—Ä–∏–±—ã–ª—å USDT (–¥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞)</label>
                            <input type="number" class="form-control" name="profit_usdt" id="profitUsdt" placeholder="–ê–≤—Ç–æ" step="0.01" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–í—ã–ø–ª–∞—Ç–∞ –ø–∞—Ä—Ç–Ω–µ—Ä—É</label>
                            <input type="text" class="form-control" id="referrerPayout" placeholder="0" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</label>
                            <input type="text" class="form-control" id="netProfit" placeholder="–ê–≤—Ç–æ" readonly style="font-weight: 600; color: #10b981;">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–ü—Ä–∏–±—ã–ª—å %</label>
                            <input type="number" class="form-control" name="profit_percent" id="profitPercent" placeholder="%" step="0.1" readonly>
                        </div>
                        <div class="form-group" id="exchangeRateGroup">
                            <label class="form-label">–ö—É—Ä—Å –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞</label>
                            <input type="number" class="form-control" name="exchange_rate" placeholder="2.85" step="0.0001">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–î–∞—Ç–∞ —Å–¥–µ–ª–∫–∏</label>
                            <input type="date" class="form-control" name="created_at" id="dealDate">
                            <small style="color: #666;">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã</small>
                        </div>
                        <div class="form-group" style="flex: 2;">
                            <label class="form-label">–ó–∞–º–µ—Ç–∫–∏</label>
                            <textarea class="form-control" name="notes" rows="2" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É</button>
                        <button type="button" class="btn btn-secondary" onclick="calculateProfit()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–∏–±—ã–ª—å</button>
                    </div>
                    </div><!-- /standardDealSection -->
                </form>
            </div>
        </section>
        
        <!-- Cash Section -->
        <section id="cash" class="section">
            <div class="stats-grid">
                <div class="stat-card success">
                    <div class="stat-value" id="totalCashThb">0</div>
                    <div class="stat-label">–ë–∞–ª–∞–Ω—Å THB</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalCashUsdt">0</div>
                    <div class="stat-label">–≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç USDT</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgCashRate">0</div>
                    <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π –∫—É—Ä—Å</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Ç–∏—é –Ω–∞–ª–∏—á–Ω—ã—Ö</div>
                <form id="addCashBatchForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–°—É–º–º–∞ THB</label>
                            <input type="number" class="form-control" name="amount_thb" required placeholder="1000000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å USDT</label>
                            <input type="number" class="form-control" name="cost_usdt" required placeholder="28500" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ö—É—Ä—Å (–∞–≤—Ç–æ)</label>
                            <input type="text" class="form-control" id="newBatchRate" readonly placeholder="THB/USDT">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–°–ø–æ—Å–æ–± –∑–∞–∫—É–ø–∫–∏</label>
                            <select class="form-control" name="purchase_method">
                                <option value="Binance P2P">Binance P2P</option>
                                <option value="OTC –ø–∞—Ä—Ç–Ω–µ—Ä">OTC –ø–∞—Ä—Ç–Ω–µ—Ä</option>
                                <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–§–∞—É–Ω–¥–µ—Ä</label>
                            <select class="form-control" name="founder_name">
                                <option value="–ê–Ω–¥—Ä–µ–π">–ê–Ω–¥—Ä–µ–π</option>
                                <option value="–¢–µ–æ–¥–æ—Ä">–¢–µ–æ–¥–æ—Ä</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–•—ç—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</label>
                            <input type="text" class="form-control" name="tx_hash" placeholder="TxHash...">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Ç–∏—é</button>
                </form>
            </div>
            
            <div class="card">
                <div class="card-title">–ü–∞—Ä—Ç–∏–∏ –∫–∞—Å—Å—ã (FIFO - —Å–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ)</div>
                <div id="cashBatchesList">
                    <!-- Batches will be loaded here -->
                </div>
            </div>
        </section>
        
        <!-- Cards Section -->
        <section id="cards" class="section">
            <div class="stats-grid">
                <div class="stat-card success">
                    <div class="stat-value" id="totalCardsThb">0</div>
                    <div class="stat-label">–ë–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç THB</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–∞—Ä—Ç—É</div>
                <p style="color: #666; margin-bottom: 1rem;">–ö–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—É—Å—Ç–æ–π. –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ø–æ–ª–Ω–∏—Ç–µ –µ–µ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –Ω–∏–∂–µ.</p>
                
                <form id="addCardForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–ë–∞–Ω–∫</label>
                            <select class="form-control" name="bank_name" required>
                                <option value="Kasikorn">Kasikorn (KBank)</option>
                                <option value="Bangkok Bank">Bangkok Bank</option>
                                <option value="SCB">SCB</option>
                                <option value="Krungsri">Krungsri</option>
                                <option value="–î—Ä—É–≥–æ–π">–î—Ä—É–≥–æ–π</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã</label>
                            <input type="text" class="form-control" name="card_name" placeholder="–ö–∞—Ä—Ç–∞ 1, –û—Å–Ω–æ–≤–Ω–∞—è –∏ —Ç.–¥.">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–í–ª–∞–¥–µ–ª–µ—Ü</label>
                            <select class="form-control" name="holder_name">
                                <option value="–ê–Ω–¥—Ä–µ–π">–ê–Ω–¥—Ä–µ–π</option>
                                <option value="–¢–µ–æ–¥–æ—Ä">–¢–µ–æ–¥–æ—Ä</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">–°–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç—É</button>
                </form>
            </div>
            
            <div class="card">
                <div class="card-title">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –∫–∞—Ä—Ç—É</div>
                <p style="color: #666; margin-bottom: 1rem;">–ú–æ–∂–Ω–æ –ø–æ–ø–æ–ª–Ω–∏—Ç—å –∏–∑ –ø–∞—Ä—Ç–∏–∏ –∫–∞—Å—Å—ã (–∫—É—Ä—Å –∞–≤—Ç–æ) –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ–π –∑–∞–∫—É–ø–∫–æ–π.</p>
                
                <form id="topupCardForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–ö–∞—Ä—Ç–∞</label>
                            <select class="form-control" name="card_id" id="topupCardSelect" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫</label>
                            <select class="form-control" name="source_type" id="topupSourceType">
                                <option value="cash_batch">–ò–∑ –ø–∞—Ä—Ç–∏–∏ –∫–∞—Å—Å—ã</option>
                                <option value="separate">–û—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–∫—É–ø–∫–∞</option>
                            </select>
                        </div>
                        <div class="form-group" id="topupBatchGroup">
                            <label class="form-label">–ü–∞—Ä—Ç–∏—è –∫–∞—Å—Å—ã</label>
                            <select class="form-control" name="source_batch_id" id="cardSourceBatch">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä—Ç–∏—é</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–°—É–º–º–∞ THB</label>
                            <input type="number" class="form-control" name="amount_thb" id="topupAmountThb" required placeholder="500000">
                        </div>
                        <div class="form-group" id="topupCostGroup" style="display:none;">
                            <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å USDT</label>
                            <input type="number" class="form-control" name="cost_usdt" id="topupCostUsdt" placeholder="14000" step="0.01">
                        </div>
                        <div class="form-group" id="topupAutoInfo">
                            <label class="form-label">–ö—É—Ä—Å / –°—Ç–æ–∏–º–æ—Å—Ç—å (–∞–≤—Ç–æ)</label>
                            <input type="text" class="form-control" id="topupAutoCalc" readonly placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä—Ç–∏—é">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –∫–∞—Ä—Ç—É</button>
                </form>
            </div>
            
            <div class="card">
                <div class="card-title">–ö–∞—Ä—Ç—ã –±–∞–Ω–∫–æ–≤</div>
                <div id="bankCardsList">
                    <!-- Cards will be loaded here -->
                </div>
            </div>
        </section>
        
        <!-- Doverka Section -->
        <section id="doverka" class="section">
            <div class="card">
                <div class="card-title">–°–¥–µ–ª–∫–∏ –æ–∂–∏–¥–∞—é—â–∏–µ –≤—ã–ø–ª–∞—Ç—ã –æ—Ç –î–æ–≤–µ—Ä–∫–∏</div>
                <p style="color: #666; margin-bottom: 1rem;">
                    –î–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–ª–∞—á–∏–≤–∞–µ—Ç —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –∫–ª–∏–µ–Ω—Ç–æ–º. 
                    –ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Å–¥–µ–ª–∫–∏, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ.
                </p>
                
                <div id="pendingDoverkaList">
                    <!-- Pending deals will be loaded here -->
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç</div>
                <ol style="color: #666; line-height: 1.8;">
                    <li>–ö–ª–∏–µ–Ω—Ç –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç —á–µ—Ä–µ–∑ –°–ë–ü, –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –î–æ–≤–µ—Ä–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 47871)</li>
                    <li>–°–¥–µ–ª–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–û–∂–∏–¥–∞–µ—Ç –≤—ã–ø–ª–∞—Ç—ã"</li>
                    <li>–ß–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –î–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç USDT –Ω–∞ –≤–∞—à –∫–æ—à–µ–ª–µ–∫</li>
                    <li>–í—ã –∑–∞—Ö–æ–¥–∏—Ç–µ —Å—é–¥–∞, –≤–∏–¥–∏—Ç–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∏ –Ω–∞–∂–∏–º–∞–µ—Ç–µ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ"</li>
                    <li>–£–∫–∞–∑—ã–≤–∞–µ—Ç–µ —Ö—ç—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ—Ç –î–æ–≤–µ—Ä–∫–∏ –¥–ª—è —Å–≤–µ—Ä–∫–∏</li>
                </ol>
            </div>
        </section>
        
        <!-- Balance Section -->
        <section id="balance" class="section">
            <div class="card">
                <div class="card-title">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–∞–ª–∞–Ω—Å</div>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; background: #f1f5f9; padding: 0.5rem; border-radius: 10px;">
                    <button class="btn btn-sm btn-light balance-subtab-btn active" onclick="switchBalanceSubTab('binance')" id="btnSubBinance">Binance (USDT)</button>
                    <button class="btn btn-sm btn-light balance-subtab-btn" onclick="switchBalanceSubTab('cash')" id="btnSubCash">–ù–∞–ª–∏—á–Ω—ã–µ (THB)</button>
                    <button class="btn btn-sm btn-light balance-subtab-btn" onclick="switchBalanceSubTab('cards')" id="btnSubCards">–ö–∞—Ä—Ç—ã (THB)</button>
                </div>

                <!-- Binance Sub-tab -->
                <div id="subtabBinance" class="balance-subtab-content active">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <div id="walletsSummaryGrid" style="display: flex; gap: 1rem; flex-wrap: wrap; flex: 1;">
                            <!-- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                        <button class="btn btn-primary" onclick="openAddWalletModal()" style="white-space: nowrap; margin-left: 1rem;">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ—à–µ–ª–µ–∫</button>
                    </div>

                    <div id="walletHistorySection" style="display: none; background: #fff; padding: 1.5rem; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 id="currentWalletName" style="margin: 0;">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-success" onclick="openTopupModal()">+ –ü–æ–ø–æ–ª–Ω–∏—Ç—å (+)</button>
                                <button class="btn btn-outline-danger" onclick="openWithdrawModal()">- –°–ø–∏—Å–∞—Ç—å (-)</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>–î–∞—Ç–∞</th>
                                        <th>–¢–∏–ø</th>
                                        <th>–°—É–º–º–∞</th>
                                        <th>–û–ø–∏—Å–∞–Ω–∏–µ / –•—ç—à</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                                    </tr>
                                </thead>
                                <tbody id="walletHistoryTable">
                                    <!-- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Cash Sub-tab -->
                <div id="subtabCash" class="balance-subtab-content" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card success">
                            <div class="stat-value" id="totalCashThb">0</div>
                            <div class="stat-label">–ë–∞–ª–∞–Ω—Å THB</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalCashUsdt">0</div>
                            <div class="stat-label">–≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç USDT</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avgCashRate">0</div>
                            <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π –∫—É—Ä—Å</div>
                        </div>
                    </div>
                    
                    <div class="card" style="box-shadow: none; border: 1px solid #eee;">
                        <div class="card-title">–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Ç–∏—é –Ω–∞–ª–∏—á–Ω—ã—Ö</div>
                        <form id="addCashBatchForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">–°—É–º–º–∞ THB</label>
                                    <input type="number" class="form-control" name="amount_thb" required placeholder="1000000">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å USDT</label>
                                    <input type="number" class="form-control" name="cost_usdt" required placeholder="28500" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">–ö—É—Ä—Å (–∞–≤—Ç–æ)</label>
                                    <input type="text" class="form-control" id="newBatchRate" readonly placeholder="THB/USDT">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">–°–ø–æ—Å–æ–± –∑–∞–∫—É–ø–∫–∏</label>
                                    <select class="form-control" name="purchase_method">
                                        <option value="Binance P2P">Binance P2P</option>
                                        <option value="OTC –ø–∞—Ä—Ç–Ω–µ—Ä">OTC –ø–∞—Ä—Ç–Ω–µ—Ä</option>
                                        <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">–§–∞—É–Ω–¥–µ—Ä</label>
                                    <select class="form-control" name="founder_name">
                                        <option value="–ê–Ω–¥—Ä–µ–π">–ê–Ω–¥—Ä–µ–π</option>
                                        <option value="–¢–∏–º—É—Ä">–¢–∏–º—É—Ä</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">–•—ç—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</label>
                                    <input type="text" class="form-control" name="tx_hash" placeholder="TxHash...">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Ç–∏—é</button>
                        </form>
                    </div>
                    
                    <div class="card" style="box-shadow: none; border: 1px solid #eee;">
                        <div class="card-title">–ü–∞—Ä—Ç–∏–∏ –∫–∞—Å—Å—ã (FIFO - —Å–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ)</div>
                        <div id="cashBatchesList">
                            <!-- Batches will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Cards Sub-tab -->
                <div id="subtabCards" class="balance-subtab-content" style="display: none;">
                    <div class="stats-grid" style="margin-bottom: 1.5rem;">
                        <div class="stat-card success">
                            <div class="stat-value" id="totalCardsThb">0</div>
                            <div class="stat-label">–ë–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç THB</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;">–í–∞—à–∏ –∫–∞—Ä—Ç—ã</h3>
                        <button class="btn btn-primary" onclick="openAddCardModal()">+ –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É</button>
                    </div>
                    
                    <div id="bankCardsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                        <!-- Bank cards loaded here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Reimbursements Section -->
        <section id="reimbursements" class="section">
            <div class="card">
                <div class="card-title">–°–æ–∑–¥–∞—Ç—å –≤–æ–∑–º–µ—â–µ–Ω–∏–µ —Ñ–∞—É–Ω–¥–µ—Ä—É</div>
                <p style="color: #666; margin-bottom: 1rem;">
                    –ö–æ–≥–¥–∞ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç–µ —Ñ–∞—É–Ω–¥–µ—Ä—É USDT –∑–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–¥–µ–ª–æ–∫ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π, 
                    —Å–æ–∑–¥–∞–π—Ç–µ –≤–æ–∑–º–µ—â–µ–Ω–∏–µ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–¥–µ–ª–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω–æ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç.
                </p>
                
                <div id="pendingReimbursementsList">
                    <!-- Pending deals by founder will be loaded here -->
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">–ò—Å—Ç–æ—Ä–∏—è –≤–æ–∑–º–µ—â–µ–Ω–∏–π</div>
                <div id="reimbursementsList">
                    <!-- Reimbursements will be loaded here -->
                </div>
            </div>
        </section>
        
        <!-- Transactions Section -->
        <section id="transactions" class="section">
            <div class="card">
                <div class="card-title">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ—à–µ–ª—å–∫–æ–≤ (TronScan API)</div>
                
                <form id="addWalletForm" style="margin-bottom: 1rem;">
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label class="form-label">–î–æ–±–∞–≤–∏—Ç—å –∫–æ—à–µ–ª–µ–∫ TRON –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</label>
                            <input type="text" class="form-control" name="wallet_address" placeholder="TYourWalletAddress..." pattern="T[a-zA-Z0-9]{33}">
                        </div>
                        <div class="form-group" style="display: flex; align-items: flex-end;">
                            <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                </form>
                
                <div id="walletsInfo" style="margin-bottom: 1rem;">
                    <!-- Wallets info -->
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</div>
                <form id="verifyTxForm" style="margin-bottom: 1rem;">
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <input type="text" class="form-control" name="tx_hash" placeholder="–•—ç—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (64 —Å–∏–º–≤–æ–ª–∞)">
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-secondary">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                        </div>
                    </div>
                </form>
                <div id="verifyResult"></div>
            </div>
            
            <div class="card">
                <div class="card-title">–í—Ö–æ–¥—è—â–∏–µ USDT —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</div>
                <p style="color: #666; margin-bottom: 1rem;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏</p>
                
                <div class="form-row" style="margin-bottom: 1rem; align-items: flex-end;">
                    <div class="form-group" style="flex: 2;">
                        <label class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ –∫–æ—à–µ–ª—å–∫—É</label>
                        <select id="walletFilter" class="form-control" onchange="loadTransactions()">
                            <option value="">–í—Å–µ –∫–æ—à–µ–ª—å–∫–∏</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–° –¥–∞—Ç—ã</label>
                        <input type="date" id="txStartDate" class="form-control" onchange="loadTransactions()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ü–æ –¥–∞—Ç—É</label>
                        <input type="date" id="txEndDate" class="form-control" onchange="loadTransactions()">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="loadTransactions()">–û–±–Ω–æ–≤–∏—Ç—å</button>
                    </div>
                </div>
                
                <div id="availableTransactions">
                    <!-- Available transactions -->
                </div>
                
                <h4 style="margin: 1.5rem 0 1rem;">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –≤ —Å–¥–µ–ª–∫–∞—Ö</h4>
                <div id="usedTransactions">
                    <!-- Used transactions -->
                </div>
            </div>
        </section>
        
        <!-- Managers Section -->
        <section id="managers" class="section">
            <div class="card">
                <div class="card-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏</div>
                
                <form id="addManagerForm" style="margin-bottom: 1.5rem;">
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label class="form-label">–î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞</label>
                            <input type="text" class="form-control" name="manager_name" placeholder="–ò–º—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞" required>
                        </div>
                        <div class="form-group" style="display: flex; align-items: flex-end;">
                            <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                </form>
                
                <div id="managersList">
                    <!-- Managers list -->
                </div>
            </div>
        </section>
        
        <!-- Verification Section -->
        <section id="verification" class="section">
            <div class="card">
                <div class="card-title">–°–≤–µ—Ä–∫–∞ —Å–¥–µ–ª–æ–∫</div>
                
                <div class="form-row" style="margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">–î–∞—Ç–∞ –æ—Ç</label>
                        <input type="date" class="form-control" id="verifyDateFrom">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–î–∞—Ç–∞ –¥–æ</label>
                        <input type="date" class="form-control" id="verifyDateTo">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-primary" onclick="loadVerificationSummary()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–µ—Ä–∫—É</button>
                    </div>
                </div>
                
                <div id="verificationSummary">
                    <!-- Summary will be loaded here -->
                </div>
            </div>
            
            <!-- Webhook Configuration -->
            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-title">Webhook –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (n8n / Zapier / Make)</div>
                <p style="color: #666; margin-bottom: 1rem;">
                    –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–¥–µ–ª–∫–∏ (—Å—Ç–∞—Ç—É—Å "–ó–∞–≤–µ—Ä—à–µ–Ω–∞") –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π URL.
                </p>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 3;">
                        <label class="form-label">Webhook URL</label>
                        <input type="url" class="form-control" id="webhookUrl" placeholder="https://your-n8n.com/webhook/xxx">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="saveWebhookConfig()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button class="btn btn-secondary" onclick="testWebhook()">–¢–µ—Å—Ç</button>
                    </div>
                </div>
                
                <div id="webhookStatus" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
            </div>
        </section>
    </div>
    
    <!-- Modal for deal details -->
    <div class="modal" id="dealModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">–î–µ—Ç–∞–ª–∏ —Å–¥–µ–ª–∫–∏</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="dealModalContent">
                <!-- Deal details will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Modal for history -->
    <div class="modal" id="historyModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="historyModalTitle">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
                <button class="modal-close" onclick="closeHistoryModal()">&times;</button>
            </div>
            <div id="historyModalContent">
                <!-- History will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Add Wallet Modal -->
    <div id="addWalletModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddWalletModal()">&times;</span>
            <div class="card-title">–î–æ–±–∞–≤–∏—Ç—å –∫–æ—à–µ–ª–µ–∫</div>
            <form id="addWalletFormBalance">
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: Binance –û—Å–Ω–æ–≤–Ω–æ–π)</label>
                    <input type="text" class="form-control" id="newWalletLabel" placeholder="Binance" required>
                </div>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">–ê–¥—Ä–µ—Å (TRON) –∏–ª–∏ ID (–¥–ª—è –≤–∏—Ä—Ç. —É—á–µ—Ç–∞)</label>
                    <input type="text" class="form-control" id="newWalletAddress" placeholder="T... –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∏–º—è" required>
                </div>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">–ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å USDT</label>
                    <input type="number" class="form-control" id="newWalletInitialBalance" value="0" step="0.01">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">–î–æ–±–∞–≤–∏—Ç—å –∫–æ—à–µ–ª–µ–∫</button>
            </form>
        </div>
    </div>

    <!-- Topup Modal -->
    <div id="topupModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeTopupModal()">&times;</span>
            <div class="card-title">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞</div>
            <form id="topupForm">
                <input type="hidden" id="topupWalletId">
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">–¢–∏–ø –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                    <select class="form-control" id="topupType" onchange="toggleTopupSource()">
                        <option value="manual">–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</option>
                        <option value="tronscan">–í—ã–±—Ä–∞—Ç—å –∏–∑ TronScan</option>
                    </select>
                </div>
                
                <div id="topupTronscanGroup" style="display: none; margin-bottom: 1rem;">
                    <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ö–æ–¥—è—â—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</label>
                    <select class="form-control" id="topupTxSelect" onchange="selectTopupTx()">
                        <option value="">-- –ó–∞–≥—Ä—É–∑–∫–∞... --</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">–°—É–º–º–∞ USDT</label>
                    <input type="number" class="form-control" id="topupAmount" step="0.01" required>
                </div>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">–•—ç—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</label>
                    <input type="text" class="form-control" id="topupHash">
                </div>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <input type="text" class="form-control" id="topupDesc" placeholder="–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞">
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</button>
            </form>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div id="withdrawModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeWithdrawModal()">&times;</span>
            <div class="card-title">–°–ø–∏—Å–∞–Ω–∏–µ (–ø—Ä–æ—á–µ–µ)</div>
            <form id="withdrawForm">
                <input type="hidden" id="withdrawWalletId">
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">–°—É–º–º–∞ USDT</label>
                    <input type="number" class="form-control" id="withdrawAmount" step="0.01" required>
                </div>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <input type="text" class="form-control" id="withdrawDesc" placeholder="–ü—Ä–∏—á–∏–Ω–∞ —Å–ø–∏—Å–∞–Ω–∏—è" required>
                </div>
                <button type="submit" class="btn btn-danger" style="width: 100%;">–°–ø–∏—Å–∞—Ç—å</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = '';  // Same origin
        
        // ==================== Navigation ====================
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.section).classList.add('active');
                
                // Load section data
                switch(tab.dataset.section) {
                    case 'dashboard': loadDashboard(); break;
                    case 'deals': loadDeals(); break;
                    case 'create': 
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —Ä—É—á–Ω–æ–º –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
                        if (typeof editingDealId !== 'undefined' && editingDealId !== null) {
                            cancelEditMode();
                        }
                        loadCreateForm(); 
                        break;
                    case 'cash': loadCashBatches(); break;
                    case 'cards': loadBankCards(); break;
                    case 'doverka': loadPendingDoverka(); break;
                    case 'reimbursements': loadReimbursements(); break;
                    case 'transactions': loadTransactions(); break;
                    case 'managers': loadManagers(); break;
                }
            });
        });
        
        // ==================== Dashboard ====================
        async function loadDashboard() {
            switchBalanceSubTab('binance'); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–ª–∞–Ω—Å—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            try {
                const response = await fetch(`${API_URL}/api/analytics/dashboard`);
                const data = await response.json();
                
                if (data.success) {
                    const d = data.dashboard;
                    
                    // –ó–∞—â–∏—Ç–∞ –æ—Ç undefined
                    const todayDeals = d.today?.deals_count ?? 0;
                    const todayProfit = d.today?.profit_usdt ?? 0;
                    const weekProfit = d.week?.profit_usdt ?? 0;
                    const cashBalance = d.cash_balance?.total_thb ?? 0;
                    const pendingDeals = d.attention?.pending_deals ?? 0;
                    const unreimbursedFounders = d.attention?.unreimbursed_founders ?? 0;

                    document.getElementById('statsGrid').innerHTML = `
                        <div class="stat-card">
                            <div class="stat-value">${todayDeals}</div>
                            <div class="stat-label">–°–¥–µ–ª–æ–∫ —Å–µ–≥–æ–¥–Ω—è</div>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-value">$${todayProfit}</div>
                            <div class="stat-label">–ü—Ä–∏–±—ã–ª—å —Å–µ–≥–æ–¥–Ω—è</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">$${weekProfit}</div>
                            <div class="stat-label">–ü—Ä–∏–±—ã–ª—å –∑–∞ –Ω–µ–¥–µ–ª—é</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatNumber(cashBalance)} ‡∏ø</div>
                            <div class="stat-label">–ë–∞–ª–∞–Ω—Å –∫–∞—Å—Å—ã</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-value">${pendingDeals}</div>
                            <div class="stat-label">–û–∂–∏–¥–∞—é—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏</div>
                        </div>
                        <div class="stat-card ${unreimbursedFounders > 0 ? 'warning' : ''}">
                            <div class="stat-value">${unreimbursedFounders}</div>
                            <div class="stat-label">–ù–µ –≤–æ–∑–º–µ—â–µ–Ω–æ —Ñ–∞—É–Ω–¥–µ—Ä–∞–º</div>
                        </div>
                    `;
                    
                    // Alerts
                    let alertsHtml = '';
                    if (d.attention.unreimbursed_founders > 0) {
                        alertsHtml += `
                            <div class="alert alert-warning">
                                <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> ${d.attention.unreimbursed_founders} —Å–¥–µ–ª–æ–∫ –æ–∂–∏–¥–∞—é—Ç –≤–æ–∑–º–µ—â–µ–Ω–∏—è —Ñ–∞—É–Ω–¥–µ—Ä–∞–º –Ω–∞ —Å—É–º–º—É $${d.attention.unreimbursed_total_usdt}
                            </div>
                        `;
                    }
                    document.getElementById('attentionAlerts').innerHTML = alertsHtml;
                }
                
                // Load recent deals
                const dealsResponse = await fetch(`${API_URL}/api/deals?limit=5`);
                const dealsData = await dealsResponse.json();
                
                if (dealsData.success) {
                    document.getElementById('recentDealsTable').innerHTML = dealsData.deals.map(deal => `
                        <tr onclick="showDealDetails(${deal.id})" style="cursor: pointer;">
                            <td>#${deal.id}</td>
                            <td>${formatDate(deal.created_at)}</td>
                            <td>${deal.client_name || '-'}</td>
                            <td>${deal.payin_amount_usdt ? '$' + deal.payin_amount_usdt.toFixed(2) : '-'}</td>
                            <td>${deal.is_custom 
                                ? (deal.custom_payout_amount ? formatNumber(deal.custom_payout_amount) + ' ' + deal.custom_payout_currency : '-')
                                : (deal.payout_amount_thb ? formatNumber(deal.payout_amount_thb) + ' ‡∏ø' : '-')}</td>
                            <td class="${(deal.net_profit_usdt || deal.profit_usdt) > 0 ? 'text-success' : ''}">${deal.net_profit_usdt != null ? '$' + deal.net_profit_usdt.toFixed(2) : (deal.profit_usdt ? '$' + deal.profit_usdt.toFixed(2) : '-')}</td>
                            <td><span class="badge badge-${deal.status}">${getStatusLabel(deal.status)}</span></td>
                        </tr>
                    `).join('');
                }
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }
        
        // ==================== Deals ====================
        async function loadDeals() {
            const params = new URLSearchParams();
            
            const status = document.getElementById('filterStatus').value;
            const manager = document.getElementById('filterManager').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            
            if (status) params.append('status', status);
            if (manager) params.append('manager', manager);
            if (dateFrom) params.append('date_from', dateFrom);
            if (dateTo) params.append('date_to', dateTo);
            
            try {
                const response = await fetch(`${API_URL}/api/deals?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('dealsTable').innerHTML = data.deals.map(deal => {
                        const profitUnknown = deal.payout_source === 'founder_personal' && !deal.is_reimbursed && deal.payout_amount_usdt == null;
                        return `
                        <tr>
                            <td>#${deal.id}</td>
                            <td>${formatDate(deal.created_at)}</td>
                            <td>${deal.manager_name || '-'}</td>
                            <td>${deal.client_name || '-'}</td>
                            <td>${deal.is_custom ? '–ö–∞—Å—Ç–æ–º–Ω–∞—è' : getPayinMethodLabel(deal.payin_method)}</td>
                            <td>${deal.payin_amount_usdt ? '$' + deal.payin_amount_usdt.toFixed(2) : '-'}</td>
                            <td>${deal.is_custom 
                                ? (deal.custom_payout_amount ? formatNumber(deal.custom_payout_amount) + ' ' + deal.custom_payout_currency : '-')
                                : (deal.payout_amount_thb ? formatNumber(deal.payout_amount_thb) + ' ‡∏ø' : '-')}</td>
                            <td style="color: ${profitUnknown ? '#f59e0b' : ((deal.net_profit_usdt || deal.profit_usdt) > 0 ? '#10b981' : '#ef4444')}; font-weight: 600;">
                                ${profitUnknown ? '‚è≥ –æ–∂–∏–¥.' : (deal.net_profit_usdt != null ? '$' + deal.net_profit_usdt.toFixed(2) : (deal.profit_usdt != null ? '$' + deal.profit_usdt.toFixed(2) : '-'))}
                            </td>
                            <td><span class="badge badge-${deal.status}">${getStatusLabel(deal.status)}</span></td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="showDealDetails(${deal.id})">–î–µ—Ç–∞–ª–∏</button>
                            </td>
                        </tr>
                    `}).join('');
                }
            } catch (error) {
                console.error('Error loading deals:', error);
            }
        }
        
        async function showDealDetails(dealId) {
            try {
                const response = await fetch(`${API_URL}/api/deals/${dealId}`);
                const data = await response.json();
                
                let incomingTxOptions = '';
                if (data.success && data.deal.payin_method === 'spp_doverka') {
                    try {
                        const txResponse = await fetch(`${API_URL}/api/transactions/incoming`);
                        const txData = await txResponse.json();
                        if (txData.success && txData.available) {
                            incomingTxOptions = txData.available.slice(0, 50).map(tx => 
                                `<option value="${tx.tx_hash}">+$${tx.amount_usdt.toFixed(2)} | ${tx.from_address?.substring(0, 10)}... | ${formatDate(tx.timestamp)}</option>`
                            ).join('');
                        }
                    } catch (e) {
                        console.error('Error loading tx for modal:', e);
                    }
                }
                
                if (data.success) {
                    const deal = data.deal;
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ—à–µ–ª—å–∫–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–ø–∏—Å–∞–Ω–∏—è, –µ—Å–ª–∏ —ç—Ç–æ Binance
                    let walletOptions = '';
                    let selectedWalletLabel = '';
                    if (deal.payout_source === 'binance') {
                        try {
                            const wResp = await fetch(`${API_URL}/api/wallets/summary`);
                            const wData = await wResp.json();
                            if (wData.success) {
                                walletOptions = wData.wallets.map(w => {
                                    if (deal.payout_wallet_id == w.id) selectedWalletLabel = w.label || w.address.substring(0,8);
                                    return `<option value="${w.id}" ${deal.payout_wallet_id == w.id ? 'selected' : ''}>${w.label || w.address.substring(0,8)}</option>`;
                                }).join('');
                            }
                        } catch (e) {}
                    }

                    const profitUnknown = deal.payout_source === 'founder_personal' && !deal.is_reimbursed && deal.payout_amount_usdt == null;
                    const isDoverka = deal.payin_method === 'spp_doverka';
                    const dovekraNotConfirmed = isDoverka && deal.doverka_status !== 'confirmed';
                    
                    document.getElementById('dealModalContent').innerHTML = `
                        <div class="form-row">
                            <div><strong>ID:</strong> #${deal.id}</div>
                            <div><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="badge badge-${deal.status}">${getStatusLabel(deal.status)}</span></div>
                        </div>
                        <hr style="margin: 1rem 0;">
                        
                        <h4 style="color: #10b981; margin-bottom: 0.5rem;">Pay-In</h4>
                        ${deal.is_custom ? `
                            <p><strong>–í–∞–ª—é—Ç–∞:</strong> ${deal.custom_payin_currency}</p>
                            <p><strong>–°—É–º–º–∞:</strong> ${formatNumber(deal.custom_payin_amount)} ${deal.custom_payin_currency}</p>
                            ${deal.custom_payin_rate ? `<p><strong>–ö—É—Ä—Å –∫ USDT:</strong> ${deal.custom_payin_rate}</p>` : ''}
                            <p><strong>= USDT:</strong> $${deal.payin_amount_usdt?.toFixed(2) || '-'}</p>
                        ` : `
                            <p><strong>–ú–µ—Ç–æ–¥:</strong> ${getPayinMethodLabel(deal.payin_method)}</p>
                            ${deal.payin_amount_rub ? `<p><strong>–°—É–º–º–∞ RUB:</strong> ${formatNumber(deal.payin_amount_rub)} ‚ÇΩ</p>` : ''}
                            <p><strong>–°—É–º–º–∞ USDT:</strong> $${deal.payin_amount_usdt || '-'}</p>
                        `}
                        ${deal.payin_partner_name ? `<p><strong>–ü–∞—Ä—Ç–Ω–µ—Ä:</strong> ${deal.payin_partner_name}</p>` : ''}
                        ${deal.payin_tx_hash ? `<p><strong>–•—ç—à Pay-In:</strong> <a href="https://tronscan.org/#/transaction/${deal.payin_tx_hash}" target="_blank" style="background: #e0f2fe; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 0.85rem; text-decoration: none; color: #0369a1;">${deal.payin_tx_hash.substring(0, 20)}...</a> <span onclick="copyHash('${deal.payin_tx_hash}')" style="cursor: pointer;" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">üìã</span> ${deal.payin_tx_verified ? '‚úÖ' : '‚è≥'}</p>` : ''}
                        
                        ${isDoverka ? `
                            <div style="background: #fef3c7; padding: 0.75rem; border-radius: 8px; margin-top: 0.5rem;">
                                <p style="margin-bottom: 0.5rem;"><strong>–î–æ–≤–µ—Ä–∫–∞ ID:</strong> ${deal.doverka_transaction_id || '-'}</p>
                                <p style="margin-bottom: 0.5rem;"><strong>–°—Ç–∞—Ç—É—Å –î–æ–≤–µ—Ä–∫–∏:</strong> 
                                    <span style="color: ${deal.doverka_status === 'confirmed' ? '#10b981' : '#f59e0b'}; font-weight: 600;">
                                        ${deal.doverka_status === 'confirmed' ? '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ' : deal.doverka_status === 'paid' ? 'üí∞ –í—ã–ø–ª–∞—á–µ–Ω–æ' : '‚è≥ –û–∂–∏–¥–∞–µ—Ç –≤—ã–ø–ª–∞—Ç—ã'}
                                    </span>
                                </p>
                                ${deal.doverka_payout_hash ? `<p><strong>–•—ç—à –æ—Ç –î–æ–≤–µ—Ä–∫–∏:</strong> <a href="https://tronscan.org/#/transaction/${deal.doverka_payout_hash}" target="_blank" style="background: #e0f2fe; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 0.85rem; text-decoration: none; color: #0369a1;">${deal.doverka_payout_hash.substring(0, 20)}...</a> <span onclick="copyHash('${deal.doverka_payout_hash}')" style="cursor: pointer;" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">üìã</span></p>` : ''}
                                
                                ${dovekraNotConfirmed ? `
                                    <hr style="margin: 0.75rem 0; border-color: #fbbf24;">
                                    <p style="font-size: 0.9rem; margin-bottom: 0.5rem;"><strong>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç –î–æ–≤–µ—Ä–∫–∏:</strong></p>
                                    <select class="form-control" id="doverkaModalTxSelect" onchange="selectDoverkaModalTx()" style="margin-bottom: 0.5rem;">
                                        <option value="">-- –í—ã–±—Ä–∞—Ç—å –≤—Ö–æ–¥—è—â—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é --</option>
                                        ${incomingTxOptions}
                                    </select>
                                    <input type="text" class="form-control" id="doverkaModalTxHash" placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Ö—ç—à –≤—Ä—É—á–Ω—É—é..." style="margin-bottom: 0.5rem;">
                                    <button class="btn btn-success btn-sm" onclick="confirmDoverkaFromModal(${deal.id})">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ</button>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <hr style="margin: 1rem 0;">
                        
                        <h4 style="color: #ef4444; margin-bottom: 0.5rem;">Pay-Out</h4>
                        ${deal.is_custom ? `
                            <p><strong>–í–∞–ª—é—Ç–∞:</strong> ${deal.custom_payout_currency}</p>
                            <p><strong>–°—É–º–º–∞:</strong> ${formatNumber(deal.custom_payout_amount)} ${deal.custom_payout_currency}</p>
                            ${deal.custom_payout_rate ? `<p><strong>–ö—É—Ä—Å –∫ USDT:</strong> ${deal.custom_payout_rate}</p>` : ''}
                            <p><strong>= USDT:</strong> $${deal.payout_amount_usdt?.toFixed(2) || '-'}</p>
                            <p><strong>–ú–µ—Ç–æ–¥ –≤—ã–¥–∞—á–∏:</strong> ${getPayoutMethodLabel(deal.payout_method)}</p>
                        ` : `
                            <p><strong>–ú–µ—Ç–æ–¥:</strong> ${getPayoutMethodLabel(deal.payout_method)}</p>
                            <p><strong>–ò—Å—Ç–æ—á–Ω–∏–∫:</strong> ${getPayoutSourceLabel(deal.payout_source)} ${selectedWalletLabel ? `(${selectedWalletLabel})` : ''}</p>
                            ${deal.payout_source === 'binance' ? `
                                <div style="background: #f1f5f9; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.5rem;">
                                    <label style="font-size: 0.8rem; color: #666;">–ö–æ—à–µ–ª–µ–∫ —Å–ø–∏—Å–∞–Ω–∏—è:</label>
                                    <select class="form-control form-control-sm" id="modalPayoutWalletId" onchange="updateDealWallet(${deal.id}, this.value)">
                                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ --</option>
                                        ${walletOptions}
                                    </select>
                                </div>
                            ` : ''}
                            <p><strong>–°—É–º–º–∞ THB:</strong> ${formatNumber(deal.payout_amount_thb)} ‡∏ø</p>
                            <p><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å USDT:</strong> ${deal.payout_amount_usdt != null ? '$' + deal.payout_amount_usdt.toFixed(2) : '<span style="color: #f59e0b;">–û–∂–∏–¥–∞–µ—Ç –≤–æ–∑–º–µ—â–µ–Ω–∏—è</span>'}</p>
                            ${deal.cash_batch_rate ? `<p><strong>–ö—É—Ä—Å:</strong> ${deal.cash_batch_rate}</p>` : ''}
                            ${deal.payout_tx_hash ? `<p><strong>–•—ç—à Pay-Out:</strong> <a href="https://tronscan.org/#/transaction/${deal.payout_tx_hash}" target="_blank" style="background: #fee2e2; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 0.85rem; text-decoration: none; color: #b91c1c;">${deal.payout_tx_hash.substring(0, 20)}...</a> <span onclick="copyHash('${deal.payout_tx_hash}')" style="cursor: pointer;" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">üìã</span></p>` : ''}
                            ${deal.payout_founder_name ? `<p><strong>–§–∞—É–Ω–¥–µ—Ä:</strong> ${deal.payout_founder_name}</p>` : ''}
                            ${deal.reimbursement_id ? `
                                <div style="background: #d1fae5; padding: 0.5rem; border-radius: 6px; margin-top: 0.5rem;">
                                    <strong>–í–æ–∑–º–µ—â–µ–Ω–∏–µ:</strong> #${deal.reimbursement_id} ‚úÖ
                                    ${deal.reimbursement?.tx_hash ? `<br><strong>–•—ç—à –≤–æ–∑–º–µ—â–µ–Ω–∏—è:</strong> <a href="https://tronscan.org/#/transaction/${deal.reimbursement.tx_hash}" target="_blank" style="font-family: monospace; font-size: 0.8rem; text-decoration: none; color: #065f46;">${deal.reimbursement.tx_hash.substring(0, 20)}...</a> <span onclick="copyHash('${deal.reimbursement.tx_hash}')" style="cursor: pointer;">üìã</span>` : ''}
                                </div>
                            ` : ''}
                        `}
                        
                        <hr style="margin: 1rem 0;">
                        
                        <h4 style="color: #667eea; margin-bottom: 0.5rem;">–§–∏–Ω–∞–Ω—Å—ã</h4>
                        <p><strong>–í–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å:</strong> 
                            ${profitUnknown 
                                ? '<span style="color: #f59e0b; font-weight: 600;">–û–∂–∏–¥–∞–µ—Ç –≤–æ–∑–º–µ—â–µ–Ω–∏—è</span>' 
                                : `<span style="color: #10b981;">$${(deal.profit_usdt || 0).toFixed(2)}</span> (${(deal.profit_percent || 0).toFixed(1)}%)`
                            }
                        </p>
                        ${deal.referrer_name ? `<p><strong>–ü–∞—Ä—Ç–Ω—ë—Ä:</strong> ${deal.referrer_name} (${deal.referrer_percent || 0}%) ‚Üí <span style="color: #f59e0b;">-$${(deal.referrer_payout_usdt || 0).toFixed(2)}</span></p>` : ''}
                        <p><strong>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å:</strong> 
                            ${profitUnknown 
                                ? '<span style="color: #f59e0b; font-weight: 600;">–û–∂–∏–¥–∞–µ—Ç –≤–æ–∑–º–µ—â–µ–Ω–∏—è</span>' 
                                : `<span style="color: #10b981; font-weight: 600; font-size: 1.1rem;">$${(deal.net_profit_usdt || deal.profit_usdt || 0).toFixed(2)}</span>`
                            }
                        </p>
                        ${!profitUnknown && deal.net_profit_usdt != null ? `<p><strong>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å:</strong> <span style="color: #10b981; font-weight: 600;">$${deal.net_profit_usdt.toFixed(2)}</span></p>` : ''}
                        
                        ${deal.notes ? `<hr style="margin: 1rem 0;"><p><strong>–ó–∞–º–µ—Ç–∫–∏:</strong> ${deal.notes}</p>` : ''}
                        
                        <hr style="margin: 1rem 0;">
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-warning btn-sm" onclick="openDealEditor(${deal.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            ${deal.status === 'pending' ? `<button class="btn btn-success btn-sm" onclick="updateDealStatus(${deal.id}, 'completed')">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>` : ''}
                            ${deal.status === 'completed' ? `<button class="btn btn-primary btn-sm" onclick="updateDealStatus(${deal.id}, 'verified')">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</button>` : ''}
                            <button class="btn btn-danger btn-sm" onclick="deleteDeal(${deal.id})">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    `;
                    document.getElementById('dealModal').classList.add('active');
                }
            } catch (error) {
                console.error('Error loading deal:', error);
            }
        }
        
        function selectDoverkaModalTx() {
            const select = document.getElementById('doverkaModalTxSelect');
            const hashInput = document.getElementById('doverkaModalTxHash');
            if (select && hashInput && select.value) {
                hashInput.value = select.value;
            }
        }
        
        async function confirmDoverkaFromModal(dealId) {
            const hashInput = document.getElementById('doverkaModalTxHash');
            const payoutHash = hashInput ? hashInput.value : '';
            
            try {
                const response = await fetch(`${API_URL}/api/doverka/confirm/${dealId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ payout_hash: payoutHash })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç –î–æ–≤–µ—Ä–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ!');
                    showDealDetails(dealId); // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    loadDeals();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            } catch (error) {
                console.error('Error confirming doverka:', error);
            }
        }
        
        function closeModal() {
            document.getElementById('dealModal').classList.remove('active');
        }

        async function updateDealWallet(dealId, walletId) {
            try {
                const response = await fetch(`${API_URL}/api/deals/${dealId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({payout_wallet_id: parseInt(walletId)})
                });
                if ((await response.json()).success) {
                    showDealDetails(dealId); // –û–±–Ω–æ–≤–ª—è–µ–º
                }
            } catch (e) { console.error(e); }
        }
        
        async function updateDealStatus(dealId, status) {
            try {
                const response = await fetch(`${API_URL}/api/deals/${dealId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                const data = await response.json();
                if (data.success) {
                    closeModal();
                    loadDeals();
                    loadDashboard();
                }
            } catch (error) {
                console.error('Error updating deal:', error);
            }
        }
        
        async function deleteDeal(dealId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–¥–µ–ª–∫—É? –°—Ä–µ–¥—Å—Ç–≤–∞ –≤–µ—Ä–Ω—É—Ç—Å—è –≤ –∫–∞—Å—Å—É.')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/deals/${dealId}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    closeModal();
                    loadDeals();
                    loadDashboard();
                }
            } catch (error) {
                console.error('Error deleting deal:', error);
            }
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        let editingDealId = null;
        
        async function openDealEditor(dealId) {
            try {
                const response = await fetch(`${API_URL}/api/deals/${dealId}`);
                const data = await response.json();
                
                if (data.success) {
                    const deal = data.deal;
                    editingDealId = dealId;
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    closeModal();
                    
                    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Å–æ–∑–¥–∞–Ω–∏—è
                    showSection('create');
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã (–º–µ–Ω–µ–¥–∂–µ—Ä—ã, –∫–ª–∏–µ–Ω—Ç—ã –∏ —Ç.–¥.)
                    await loadCreateForm();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                    document.querySelector('#create .card-title').innerHTML = 
                        `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–¥–µ–ª–∫—É #${dealId} <button class="btn btn-secondary btn-sm" style="margin-left: 1rem;" onclick="cancelEditMode()">–û—Ç–º–µ–Ω–∞</button>`;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º - –∫–∞—Å—Ç–æ–º–Ω–∞—è —Å–¥–µ–ª–∫–∞ –∏–ª–∏ –æ–±—ã—á–Ω–∞—è
                    
                    // –û–±—â–∏–µ –ø–æ–ª—è –¥–ª—è –æ–±–æ–∏—Ö —Ç–∏–ø–æ–≤ —Å–¥–µ–ª–æ–∫
                    const form = document.getElementById('createDealForm');
                    if (deal.manager_name) document.getElementById('managerSelect').value = deal.manager_name;
                    if (deal.client_id) document.getElementById('clientSelect').value = deal.client_id;
                    if (deal.client_name) form.client_name.value = deal.client_name;
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞—Ç—É
                    if (deal.created_at) {
                        document.getElementById('dealDate').value = deal.created_at.split('T')[0];
                    }

                    if (deal.is_custom) {
                        // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –∫–∞—Å—Ç–æ–º–Ω–æ–π —Å–¥–µ–ª–∫–∏
                        document.getElementById('customDealToggle').checked = true;
                        toggleCustomDeal();
                        
                        // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é —Ñ–æ—Ä–º—É
                        document.getElementById('customPayinAmount').value = deal.custom_payin_amount || '';
                        document.getElementById('customPayinCurrency').value = deal.custom_payin_currency || 'USDT';
                        document.getElementById('customPayinRate').value = deal.custom_payin_rate || '';
                        document.getElementById('customPayoutAmount').value = deal.custom_payout_amount || '';
                        document.getElementById('customPayoutCurrency').value = deal.custom_payout_currency || 'USDT';
                        document.getElementById('customPayoutRate').value = deal.custom_payout_rate || '';
                        document.getElementById('customPayoutMethod').value = deal.payout_method || 'office';
                        document.getElementById('customReferrerName').value = deal.referrer_name || '';
                        document.getElementById('customReferrerPercent').value = deal.referrer_percent || '';
                        document.getElementById('customNotes').value = deal.notes || '';
                        
                        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º
                        calcCustomProfit();
                        
                    } else {
                        // –û–±—ã—á–Ω–∞—è —Å–¥–µ–ª–∫–∞ - –≤—ã–∫–ª—é—á–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ä–µ–∂–∏–º
                        document.getElementById('customDealToggle').checked = false;
                        toggleCustomDeal();
                        
                        // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ–±—ã—á–Ω—É—é —Ñ–æ—Ä–º—É
                        if (deal.payin_method) {
                            document.getElementById('payinMethod').value = deal.payin_method;
                            document.getElementById('payinMethod').dispatchEvent(new Event('change'));
                        }
                        if (deal.payin_amount_usdt) form.payin_amount_usdt.value = deal.payin_amount_usdt;
                        if (deal.payin_amount_rub) form.payin_amount_rub.value = deal.payin_amount_rub;
                        if (deal.payin_tx_hash) form.payin_tx_hash.value = deal.payin_tx_hash;
                        if (deal.payin_rate_rub_usdt) form.payin_rate_rub_usdt.value = deal.payin_rate_rub_usdt;
                        if (deal.doverka_transaction_id) form.doverka_transaction_id.value = deal.doverka_transaction_id;
                        if (deal.payin_partner_name) form.payin_partner_name.value = deal.payin_partner_name;
                        if (deal.payout_method) form.payout_method.value = deal.payout_method;
                        if (deal.payout_source) {
                            document.getElementById('payoutSource').value = deal.payout_source;
                            document.getElementById('payoutSource').dispatchEvent(new Event('change'));
                        }
                        if (deal.payout_amount_thb) document.getElementById('payoutAmountThb').value = deal.payout_amount_thb;
                        if (deal.referrer_name) form.referrer_name.value = deal.referrer_name;
                        if (deal.referrer_percent) form.referrer_percent.value = deal.referrer_percent;
                        if (deal.notes) form.notes.value = deal.notes;
                        
                        // –î–ª—è Binance
                        if (deal.payout_source === 'binance') {
                            if (deal.payout_amount_usdt) document.getElementById('binanceUsdt').value = deal.payout_amount_usdt;
                            if (deal.payout_tx_hash) document.getElementById('binanceTxInput').value = deal.payout_tx_hash;
                        }
                        
                        // –î–ª—è –ª–∏—á–Ω—ã—Ö —Ñ–∞—É–Ω–¥–µ—Ä–∞
                        if (deal.payout_source === 'founder_personal' && deal.payout_founder_name) {
                            form.payout_founder_name.value = deal.payout_founder_name;
                        }
                        
                        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–∏–±—ã–ª—å
                        setTimeout(calculateProfit, 100);
                    }
                    
                    // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
                    const submitBtn = document.querySelector('#createDealForm button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
                        submitBtn.dataset.editMode = 'true';
                    }
                    
                    const customSubmitBtn = document.querySelector('#customDealSection .btn-success');
                    if (customSubmitBtn) {
                        customSubmitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
                        customSubmitBtn.onclick = () => updateCustomDeal(dealId);
                    }
                }
            } catch (error) {
                console.error('Error opening deal editor:', error);
            }
        }
        
        function cancelEditMode() {
            editingDealId = null;
            document.querySelector('#create .card-title').textContent = '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–¥–µ–ª–∫—É';
            document.getElementById('createDealForm').reset();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
            const submitBtn = document.querySelector('#createDealForm button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É';
                submitBtn.dataset.editMode = '';
            }
            
            const customSubmitBtn = document.querySelector('#customDealSection .btn-success');
            if (customSubmitBtn) {
                customSubmitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—É—é —Å–¥–µ–ª–∫—É';
                customSubmitBtn.onclick = createCustomDeal;
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é —Ñ–æ—Ä–º—É
            document.getElementById('customDealToggle').checked = false;
            toggleCustomDeal();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª—è Pay-In/Pay-Out –∫ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
            document.getElementById('payinMethod').dispatchEvent(new Event('change'));
            document.getElementById('payoutSource').dispatchEvent(new Event('change'));
        }
        
        async function updateCustomDeal(dealId) {
            const payinAmount = parseFloat(document.getElementById('customPayinAmount').value) || 0;
            const payinCurrency = document.getElementById('customPayinCurrency').value;
            const payinRate = parseFloat(document.getElementById('customPayinRate').value) || 0;
            
            const payoutAmount = parseFloat(document.getElementById('customPayoutAmount').value) || 0;
            const payoutCurrency = document.getElementById('customPayoutCurrency').value;
            const payoutRate = parseFloat(document.getElementById('customPayoutRate').value) || 0;
            
            const payoutMethod = document.getElementById('customPayoutMethod').value;
            const notes = document.getElementById('customNotes').value;
            
            const referrerName = document.getElementById('customReferrerName').value.trim();
            const referrerPercent = parseFloat(document.getElementById('customReferrerPercent').value) || 0;
            
            const managerName = document.getElementById('managerSelect').value;
            const clientId = document.getElementById('clientSelect').value;
            const clientName = document.querySelector('[name="client_name"]').value;
            const createdAt = document.getElementById('dealDate').value;
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è
            const payinUsdt = payinCurrency === 'USDT' ? payinAmount : payinAmount / payinRate;
            const payoutUsdt = payoutCurrency === 'USDT' ? payoutAmount : payoutAmount / payoutRate;
            const profit = payinUsdt - payoutUsdt;
            const referrerPayout = referrerPercent > 0 ? profit * (referrerPercent / 100) : 0;
            const netProfit = profit - referrerPayout;
            
            const data = {
                manager_name: managerName,
                client_id: parseInt(clientId) || null,
                client_name: clientName,
                created_at: createdAt || null,
                payin_amount_usdt: payinUsdt,
                payout_amount_usdt: payoutUsdt,
                payout_method: payoutMethod,
                custom_payin_currency: payinCurrency,
                custom_payin_amount: payinAmount,
                custom_payin_rate: payinCurrency !== 'USDT' ? payinRate : null,
                custom_payout_currency: payoutCurrency,
                custom_payout_amount: payoutAmount,
                custom_payout_rate: payoutCurrency !== 'USDT' ? payoutRate : null,
                referrer_name: referrerName || null,
                referrer_percent: referrerPercent || null,
                referrer_payout_usdt: referrerPayout > 0 ? referrerPayout : null,
                profit_usdt: profit,
                net_profit_usdt: netProfit,
                notes: notes || null
            };
            
            try {
                const response = await fetch(`${API_URL}/api/deals/${dealId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('–°–¥–µ–ª–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
                    cancelEditMode();
                    loadDeals();
                    loadDashboard();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                console.error('Error updating custom deal:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
            }
        }
        
        // ==================== Create Deal ====================
        
        // –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–∏
        function showSection(sectionName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            const tab = document.querySelector(`[data-section="${sectionName}"]`);
            if (tab) {
                tab.classList.add('active');
                document.getElementById(sectionName).classList.add('active');
            }
        }
        
        async function loadCreateForm() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—à—ë–ª —á–µ—Ä–µ–∑ –Ω–∞–≤–∏–≥–∞—Ü–∏—é (–Ω–µ —á–µ—Ä–µ–∑ openDealEditor)
            // –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –µ—Å–ª–∏ editingDealId —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - –∑–Ω–∞—á–∏—Ç –ø—Ä–∏—à–ª–∏ –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
            // –≠—Ç–æ –±—É–¥–µ—Ç —Å–±—Ä–æ—à–µ–Ω–æ –≤ cancelEditMode() –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
            
            // Load managers
            try {
                const response = await fetch(`${API_URL}/api/managers`);
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('managerSelect');
                    select.innerHTML = data.managers.filter(m => m.active).map(m => 
                        `<option value="${m.name}">${m.name}</option>`
                    ).join('');
                }
            } catch (error) {
                console.error('Error loading managers:', error);
            }
            
            // Load clients
            try {
                const response = await fetch(`${API_URL}/api/clients`);
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('clientSelect');
                    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–∏–∂–µ</option>' +
                        data.clients.map(c => `<option value="${c.id}">${c.name} (${c.telegram || c.phone || '–±–µ–∑ –∫–æ–Ω—Ç–∞–∫—Ç–∞'})</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading clients:', error);
            }
            
            // Load incoming transactions for crypto
            await loadIncomingTxForSelect();
            
            // Load cash batches and bank cards
            await Promise.all([
                loadCashBatchesForSelect(),
                loadBankCardsForSelect()
            ]);
            
            // Trigger payin method change to show correct fields
            document.getElementById('payinMethod').dispatchEvent(new Event('change'));
        }
        
        // Load incoming transactions for PayIn crypto select
        async function deleteWallet(walletId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ—à–µ–ª–µ–∫ –∏–∑ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞?')) return;
            try {
                const response = await fetch(`${API_URL}/api/wallets/${walletId}`, { method: 'DELETE' });
                if ((await response.json()).success) loadTransactions();
            } catch (e) { console.error(e); }
        }

        async function loadIncomingTxForSelect() {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–∞—Ç, –µ—Å–ª–∏ –æ–Ω–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
                const startDate = document.getElementById('txStartDate')?.value || '2025-12-01';
                const endDate = document.getElementById('txEndDate')?.value || '';
                
                let url = `${API_URL}/api/transactions/incoming?start_date=${startDate}`;
                if (endDate) url += `&end_date=${endDate}`;

                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.available) {
                    const select = document.getElementById('payinTxSelect');
                    select.innerHTML = '<option value="">-- –í—ã–±—Ä–∞—Ç—å –∏–∑ –≤—Ö–æ–¥—è—â–∏—Ö --</option>' +
                        data.available.slice(0, 100).map(tx => 
                            `<option value="${tx.tx_hash}" data-amount="${tx.amount_usdt}">+$${tx.amount_usdt.toFixed(2)} | ${tx.from_address?.substring(0, 10)}... | ${formatDate(tx.timestamp)}</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Error loading incoming transactions:', error);
            }
        }
        
        function selectPayinTx(select) {
            const txHash = select.value;
            const amount = select.selectedOptions[0]?.dataset?.amount;
            
            if (txHash) {
                document.querySelector('[name="payin_tx_hash"]').value = txHash;
            }
            if (amount) {
                document.querySelector('[name="payin_amount_usdt"]').value = amount;
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ö–æ–¥—è—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è Binance
        async function loadOutgoingTxForBinance() {
            const select = document.getElementById('binanceTxSelect');
            select.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
            
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–∞—Ç, –µ—Å–ª–∏ –æ–Ω–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
                const startDate = document.getElementById('txStartDate')?.value || '2025-12-01';
                const endDate = document.getElementById('txEndDate')?.value || '';
                
                let url = `${API_URL}/api/transactions/outgoing?start_date=${startDate}`;
                if (endDate) url += `&end_date=${endDate}`;

                const response = await fetch(url);
                const data = await response.json();
                
                select.innerHTML = '<option value="">-- –í—ã–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞ --</option>';
                
                // API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç available (–∏—Å—Ö–æ–¥—è—â–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
                const transactions = data.available || data.transactions || [];
                
                if (transactions.length > 0) {
                    transactions.slice(0, 100).forEach(tx => {
                        const date = formatDate(tx.timestamp);
                        const amount = tx.amount_usdt ? parseFloat(tx.amount_usdt).toFixed(2) : '?';
                        const shortHash = tx.tx_hash.substring(0, 10) + '...';
                        const opt = document.createElement('option');
                        opt.value = tx.tx_hash;
                        opt.textContent = `-$${amount} | ${shortHash} | ${date}`;
                        opt.dataset.amount = tx.amount_usdt;
                        select.appendChild(opt);
                    });
                } else {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = '–ù–µ—Ç –∏—Å—Ö–æ–¥—è—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π';
                    opt.disabled = true;
                    select.appendChild(opt);
                }
            } catch (error) {
                console.error('Error loading outgoing tx:', error);
                select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
            }
        }
        
        function selectBinanceTx() {
            const select = document.getElementById('binanceTxSelect');
            const txHash = select.value;
            const amount = select.selectedOptions[0]?.dataset?.amount;
            
            if (txHash) {
                document.getElementById('binanceTxInput').value = txHash;
            }
            if (amount) {
                // –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å—é —Å—É–º–º—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —É–º–µ–Ω—å—à–∏—Ç—å
                document.getElementById('binanceUsdt').value = parseFloat(amount).toFixed(2);
                calcBinanceRate();
            }
        }
        
        function calcBinanceRate() {
            const thb = parseFloat(document.getElementById('payoutAmountThb')?.value) || 0;
            const usdt = parseFloat(document.getElementById('binanceUsdt')?.value) || 0;
            const rateEl = document.getElementById('binanceRate');
            
            if (thb > 0 && usdt > 0) {
                const rate = thb / usdt;
                rateEl.value = rate.toFixed(4);
            } else {
                rateEl.value = '';
            }
            calculateProfit();
        }
        
        let cashBatchesData = [];
        let bankCardsData = [];
        
        async function loadCashBatchesForSelect() {
            try {
                const response = await fetch(`${API_URL}/api/cash/balance`);
                const data = await response.json();
                
                if (data.success) {
                    cashBatchesData = data.batches;
                    
                    // Info about cash balance
                    const infoHtml = data.batches.length > 0 
                        ? `<strong>${formatNumber(data.total_thb)} THB</strong> –¥–æ—Å—Ç—É–ø–Ω–æ (${data.batches.length} –ø–∞—Ä—Ç–∏–π)<br>
                           <small>–ê–≤—Ç–æ-—Å–ø–∏—Å–∞–Ω–∏–µ FIFO: —Å–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ –ø–∞—Ä—Ç–∏–∏</small>`
                        : '<span style="color: #ef4444;">–ö–∞—Å—Å–∞ –ø—É—Å—Ç–∞</span>';
                    document.getElementById('cashBalanceInfo').innerHTML = infoHtml;
                    
                    // For card source batch
                    const cardSourceSelect = document.getElementById('cardSourceBatch');
                    if (cardSourceSelect) {
                        cardSourceSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä—Ç–∏—é</option>' +
                            data.batches.map(b => 
                                `<option value="${b.id}" data-rate="${b.purchase_rate}" data-remaining="${b.remaining_thb}">–ü–∞—Ä—Ç–∏—è #${b.id}: ${formatNumber(b.remaining_thb)} THB (–∫—É—Ä—Å ${b.purchase_rate})</option>`
                            ).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading cash batches:', error);
            }
        }
        
        async function loadBankCardsForSelect() {
            try {
                const response = await fetch(`${API_URL}/api/cards/balance`);
                const data = await response.json();
                
                if (data.success) {
                    bankCardsData = data.cards;
                    
                    const select = document.getElementById('bankCardSelect');
                    if (select) {
                        select.innerHTML = data.cards.length > 0 
                            ? data.cards.map(c => 
                                `<option value="${c.id}" data-rate="${c.avg_rate}" data-remaining="${c.balance_thb}">
                                    ${c.bank_name} (${c.holder_name}): ${formatNumber(c.balance_thb)} THB
                                </option>`
                            ).join('')
                            : '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞—Ä—Ç</option>';
                        
                        // Update info for first card
                        if (data.cards.length > 0) {
                            const first = data.cards[0];
                            document.getElementById('bankCardInfo').value = 
                                `${formatNumber(first.balance_thb)} THB / –∫—É—Ä—Å ${first.avg_rate}`;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading bank cards:', error);
            }
        }
        
        // Update card info when selected
        document.getElementById('bankCardSelect')?.addEventListener('change', function() {
            const selected = this.options[this.selectedIndex];
            if (selected.dataset.rate) {
                document.getElementById('bankCardInfo').value = 
                    `${formatNumber(selected.dataset.remaining)} THB / –∫—É—Ä—Å ${selected.dataset.rate}`;
            }
        });
        
        // Show/hide fields based on payin method
        document.getElementById('payinMethod').addEventListener('change', function() {
            const partnerGroup = document.getElementById('payinPartnerGroup');
            const rubGroup = document.getElementById('payinRubGroup');
            const doverkaGroup = document.getElementById('doverkaGroup');
            const txHashGroup = document.getElementById('payinTxHashGroup');
            const rateGroup = document.getElementById('payinRateGroup');
            const exchangeRateGroup = document.getElementById('exchangeRateGroup');
            
            const isCryptoDirect = this.value === 'crypto_direct';
            
            // –ü–∞—Ä—Ç–Ω–µ—Ä—ã
            if (this.value === 'partners_cash') {
                partnerGroup.style.display = 'block';
            } else {
                partnerGroup.style.display = 'none';
            }
            
            // –†—É–±–ª–∏ –∏ –∫—É—Ä—Å RUB/USDT - —Å–∫—Ä—ã–≤–∞–µ–º –¥–ª—è –∫—Ä–∏–ø—Ç—ã
            if (this.value === 'spp_doverka' || this.value === 'partners_cash') {
                rubGroup.style.display = 'block';
                rateGroup.style.display = 'block';
            } else {
                rubGroup.style.display = 'none';
                rateGroup.style.display = 'none';
            }
            
            // –ö—É—Ä—Å –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ - —Å–∫—Ä—ã–≤–∞–µ–º –¥–ª—è –∫—Ä–∏–ø—Ç—ã
            if (isCryptoDirect) {
                exchangeRateGroup.style.display = 'none';
            } else {
                exchangeRateGroup.style.display = 'block';
            }
            
            // –î–æ–≤–µ—Ä–∫–∞
            if (this.value === 'spp_doverka') {
                doverkaGroup.style.display = 'flex';
                txHashGroup.style.display = 'none';
            } else {
                doverkaGroup.style.display = 'none';
                txHashGroup.style.display = 'block';
            }
        });
        
        // Show/hide fields based on payout source
        document.getElementById('payoutSource').addEventListener('change', function() {
            const cashGroup = document.getElementById('cashBatchGroup');
            const cardGroup = document.getElementById('bankCardGroup');
            const binanceGroup = document.getElementById('binanceGroup');
            const binanceGroup2 = document.getElementById('binanceGroup2');
            const founderGroup = document.getElementById('founderGroup');
            
            cashGroup.style.display = 'none';
            cardGroup.style.display = 'none';
            binanceGroup.style.display = 'none';
            binanceGroup2.style.display = 'none';
            founderGroup.style.display = 'none';
            
            if (this.value === 'cash_batch') {
                cashGroup.style.display = 'flex';
            } else if (this.value === 'bank_card') {
                cardGroup.style.display = 'flex';
            } else if (this.value === 'binance') {
                binanceGroup.style.display = 'flex';
                document.getElementById('binanceGroup2').style.display = 'flex';
                loadOutgoingTxForBinance();
            } else if (this.value === 'founder_personal') {
                founderGroup.style.display = 'flex';
            }
            
            calculateProfit();
        });
        
        // Binance USDT input triggers recalculation
        document.getElementById('binanceUsdt')?.addEventListener('input', function() {
            calcBinanceRate();
        });
        
        document.getElementById('payoutAmountThb')?.addEventListener('input', function() {
            const payoutSource = document.getElementById('payoutSource')?.value;
            if (payoutSource === 'binance') {
                calcBinanceRate();
            }
        });
        
        // ==================== Custom Deal ====================
        function toggleCustomDeal() {
            const isCustom = document.getElementById('customDealToggle').checked;
            document.getElementById('customDealSection').style.display = isCustom ? 'block' : 'none';
            document.getElementById('standardDealSection').style.display = isCustom ? 'none' : 'block';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º required –¥–ª—è –ø–æ–ª–µ–π
            const standardRequired = ['payin_method', 'payout_method', 'payout_source'];
            standardRequired.forEach(name => {
                const el = document.querySelector(`[name="${name}"]`);
                if (el) el.required = !isCustom;
            });
            
            if (isCustom) calcCustomProfit();
        }
        
        function calcCustomProfit() {
            const payinAmount = parseFloat(document.getElementById('customPayinAmount').value) || 0;
            const payinCurrency = document.getElementById('customPayinCurrency').value;
            const payinRate = parseFloat(document.getElementById('customPayinRate').value) || 0;
            
            const payoutAmount = parseFloat(document.getElementById('customPayoutAmount').value) || 0;
            const payoutCurrency = document.getElementById('customPayoutCurrency').value;
            const payoutRate = parseFloat(document.getElementById('customPayoutRate').value) || 0;
            
            // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–ª–µ –∫—É—Ä—Å–∞ –¥–ª—è USDT
            document.getElementById('customPayinRateGroup').style.display = payinCurrency === 'USDT' ? 'none' : 'block';
            document.getElementById('customPayoutRateGroup').style.display = payoutCurrency === 'USDT' ? 'none' : 'block';
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ USDT
            let payinUsdt = 0;
            if (payinCurrency === 'USDT') {
                payinUsdt = payinAmount;
            } else if (payinRate > 0) {
                payinUsdt = payinAmount / payinRate;
            }
            
            let payoutUsdt = 0;
            if (payoutCurrency === 'USDT') {
                payoutUsdt = payoutAmount;
            } else if (payoutRate > 0) {
                payoutUsdt = payoutAmount / payoutRate;
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            document.getElementById('customPayinUsdt').value = payinUsdt > 0 ? '$' + payinUsdt.toFixed(2) : '';
            document.getElementById('customPayoutUsdt').value = payoutUsdt > 0 ? '$' + payoutUsdt.toFixed(2) : '';
            
            // –ü—Ä–∏–±—ã–ª—å
            const profit = payinUsdt - payoutUsdt;
            const profitEl = document.getElementById('customProfitUsdt');
            const netProfitEl = document.getElementById('customNetProfit');
            const referrerPayoutEl = document.getElementById('customReferrerPayout');
            
            // –ü–∞—Ä—Ç–Ω—ë—Ä
            const referrerPercent = parseFloat(document.getElementById('customReferrerPercent').value) || 0;
            const referrerPayout = profit > 0 ? profit * (referrerPercent / 100) : 0;
            const netProfit = profit - referrerPayout;
            
            if (payinUsdt > 0 && payoutUsdt > 0) {
                profitEl.value = '$' + profit.toFixed(2);
                profitEl.style.color = profit >= 0 ? '#10b981' : '#ef4444';
                
                referrerPayoutEl.value = referrerPercent > 0 ? '$' + referrerPayout.toFixed(2) : '-';
                
                netProfitEl.value = '$' + netProfit.toFixed(2);
                netProfitEl.style.color = netProfit >= 0 ? '#10b981' : '#ef4444';
            } else {
                profitEl.value = '';
                netProfitEl.value = '';
                referrerPayoutEl.value = '';
            }
        }
        
        async function createCustomDeal() {
            const payinAmount = parseFloat(document.getElementById('customPayinAmount').value) || 0;
            const payinCurrency = document.getElementById('customPayinCurrency').value;
            const payinRate = parseFloat(document.getElementById('customPayinRate').value) || 0;
            
            const payoutAmount = parseFloat(document.getElementById('customPayoutAmount').value) || 0;
            const payoutCurrency = document.getElementById('customPayoutCurrency').value;
            const payoutRate = parseFloat(document.getElementById('customPayoutRate').value) || 0;
            
            const payoutMethod = document.getElementById('customPayoutMethod').value;
            const notes = document.getElementById('customNotes').value;
            const customDate = document.getElementById('customDealDate').value;
            
            // –ü–∞—Ä—Ç–Ω—ë—Ä
            const referrerName = document.getElementById('customReferrerName').value.trim();
            const referrerPercent = parseFloat(document.getElementById('customReferrerPercent').value) || 0;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (payinAmount <= 0 || payoutAmount <= 0) {
                alert('–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—ã Pay-In –∏ Pay-Out');
                return;
            }
            
            if (payinCurrency !== 'USDT' && payinRate <= 0) {
                alert('–£–∫–∞–∂–∏—Ç–µ –∫—É—Ä—Å Pay-In –∫ USDT');
                return;
            }
            
            if (payoutCurrency !== 'USDT' && payoutRate <= 0) {
                alert('–£–∫–∞–∂–∏—Ç–µ –∫—É—Ä—Å Pay-Out –∫ USDT');
                return;
            }
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è
            const payinUsdt = payinCurrency === 'USDT' ? payinAmount : payinAmount / payinRate;
            const payoutUsdt = payoutCurrency === 'USDT' ? payoutAmount : payoutAmount / payoutRate;
            const profit = payinUsdt - payoutUsdt;
            const referrerPayout = referrerPercent > 0 ? profit * (referrerPercent / 100) : 0;
            const netProfit = profit - referrerPayout;
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Ñ–æ—Ä–º—ã
            const managerName = document.getElementById('managerSelect').value;
            const clientId = document.getElementById('clientSelect').value;
            const clientName = document.querySelector('[name="client_name"]').value;
            
            const data = {
                deal_type: 'pay_in',
                status: 'completed',  // –ö–∞—Å—Ç–æ–º–Ω–∞—è —Å–¥–µ–ª–∫–∞ —Å—Ä–∞–∑—É –∑–∞–≤–µ—Ä—à–µ–Ω–∞
                manager_name: managerName,
                client_id: clientId ? parseInt(clientId) : null,
                client_name: clientName || null,
                
                // –ö–∞—Å—Ç–æ–º–Ω–∞—è –¥–∞—Ç–∞ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞) - –¥–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è 12:00 —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏
                created_at: customDate ? new Date(customDate + 'T12:00:00').toISOString() : null,
                
                // –§–ª–∞–≥ –∫–∞—Å—Ç–æ–º–Ω–æ–π —Å–¥–µ–ª–∫–∏
                is_custom: true,
                
                // Pay-In
                payin_method: 'crypto_direct',  // –ë–∞–∑–æ–≤—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                payin_amount_usdt: payinUsdt,
                
                // –ö–∞—Å—Ç–æ–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Pay-In
                custom_payin_currency: payinCurrency,
                custom_payin_amount: payinAmount,
                custom_payin_rate: payinCurrency !== 'USDT' ? payinRate : null,
                
                // Pay-Out
                payout_method: payoutMethod,
                payout_source: 'binance',  // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                payout_amount_thb: payoutCurrency === 'THB' ? payoutAmount : null,
                payout_amount_usdt: payoutUsdt,
                
                // –ö–∞—Å—Ç–æ–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Pay-Out
                custom_payout_currency: payoutCurrency,
                custom_payout_amount: payoutAmount,
                custom_payout_rate: payoutCurrency !== 'USDT' ? payoutRate : null,
                
                // –ü–∞—Ä—Ç–Ω—ë—Ä
                referrer_name: referrerName || null,
                referrer_percent: referrerPercent || null,
                referrer_payout_usdt: referrerPayout > 0 ? referrerPayout : null,
                
                // –ü—Ä–∏–±—ã–ª—å
                profit_usdt: profit,
                profit_percent: payinUsdt > 0 ? (profit / payinUsdt * 100) : 0,
                net_profit_usdt: netProfit,
                
                // –ó–∞–º–µ—Ç–∫–∏
                notes: notes || null
            };
            
            try {
                const response = await fetch(`${API_URL}/api/deals`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.success) {
                    let msg = `–ö–∞—Å—Ç–æ–º–Ω–∞—è —Å–¥–µ–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!\n\nPayIn: $${payinUsdt.toFixed(2)}\nPayOut: $${payoutUsdt.toFixed(2)}\n–í–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å: $${profit.toFixed(2)}`;
                    if (referrerName && referrerPercent > 0) {
                        msg += `\n\n–ü–∞—Ä—Ç–Ω—ë—Ä: ${referrerName} (${referrerPercent}%)\n–í—ã–ø–ª–∞—Ç–∞ –ø–∞—Ä—Ç–Ω—ë—Ä—É: $${referrerPayout.toFixed(2)}`;
                    }
                    msg += `\n\n–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å: $${netProfit.toFixed(2)}`;
                    alert(msg);
                    
                    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
                    document.getElementById('customPayinAmount').value = '';
                    document.getElementById('customPayoutAmount').value = '';
                    document.getElementById('customPayinRate').value = '';
                    document.getElementById('customPayoutRate').value = '';
                    document.getElementById('customReferrerName').value = '';
                    document.getElementById('customReferrerPercent').value = '';
                    document.getElementById('customNotes').value = '';
                    calcCustomProfit();
                    
                    loadDashboard();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                console.error('Error creating custom deal:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–¥–µ–ª–∫–∏');
            }
        }
        
        function calculateProfit() {
            const form = document.getElementById('createDealForm');
            const payinUsdt = parseFloat(form.payin_amount_usdt.value) || 0;
            const payoutThb = parseFloat(form.payout_amount_thb.value) || 0;
            const payoutSource = form.payout_source.value;
            
            // –ï—Å–ª–∏ –¢–û–õ–¨–ö–û –ª–∏—á–Ω—ã–µ —Ñ–∞—É–Ω–¥–µ—Ä–∞ - –ø—Ä–∏–±—ã–ª—å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞
            if (payoutSource === 'founder_personal') {
                document.getElementById('profitUsdt').value = '';
                document.getElementById('profitUsdt').placeholder = '–ü–æ—Å–ª–µ –≤–æ–∑–º–µ—â–µ–Ω–∏—è';
                document.getElementById('profitPercent').value = '';
                document.getElementById('profitPercent').placeholder = '?';
                document.getElementById('cashBatchCostUsdt').value = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                document.getElementById('referrerPayout').value = '–ü–æ—Å–ª–µ –≤–æ–∑–º–µ—â–µ–Ω–∏—è';
                document.getElementById('netProfit').value = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                document.getElementById('netProfit').style.color = '#f59e0b';
                return;
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫—É—Ä—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞
            let avgRate = 35; // –§–æ–ª–ª–±—ç–∫
            
            if (payoutSource === 'cash_batch' && cashBatchesData.length > 0) {
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω—ã–π –∫—É—Ä—Å –¥–ª—è FIFO
                let remaining = payoutThb;
                let totalUsdt = 0;
                for (const batch of cashBatchesData) {
                    if (remaining <= 0) break;
                    const take = Math.min(batch.remaining_thb, remaining);
                    totalUsdt += take / batch.purchase_rate;
                    remaining -= take;
                }
                avgRate = remaining <= 0 ? payoutThb / totalUsdt : 35;
            } else if (payoutSource === 'bank_card') {
                const select = document.getElementById('bankCardSelect');
                const selected = select.options[select.selectedIndex];
                avgRate = parseFloat(selected?.dataset?.rate) || 35;
            } else if (payoutSource === 'binance') {
                // Binance - USDT –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –ø–æ–ª—è
                const binanceUsdt = parseFloat(document.getElementById('binanceUsdt')?.value) || 0;
                if (binanceUsdt > 0) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ USDT, –Ω–µ —á–µ—Ä–µ–∑ –∫—É—Ä—Å
                    const profit = payinUsdt - binanceUsdt;
                    const profitPercent = binanceUsdt > 0 ? (profit / binanceUsdt) * 100 : 0;
                    
                    // –ü–∞—Ä—Ç–Ω–µ—Ä-—Ä–µ—Ñ–µ—Ä–µ—Ä
                    const referrerPercent = parseFloat(form.referrer_percent?.value) || 0;
                    const referrerFixed = parseFloat(form.referrer_fixed_usdt?.value) || 0;
                    let referrerPayout = 0;
                    
                    if (referrerPercent > 0 && profit > 0) {
                        referrerPayout = profit * (referrerPercent / 100);
                    } else if (referrerFixed > 0) {
                        referrerPayout = referrerFixed;
                    }
                    
                    const netProfit = profit - referrerPayout;
                    const exchangeRate = payinUsdt > 0 && payoutThb > 0 ? payoutThb / payinUsdt : 0;
                    
                    document.getElementById('profitUsdt').value = profit.toFixed(2);
                    document.getElementById('profitUsdt').style.color = profit >= 0 ? '#10b981' : '#ef4444';
                    document.getElementById('profitPercent').value = profitPercent.toFixed(2);
                    document.getElementById('cashBatchCostUsdt').value = '$' + binanceUsdt.toFixed(2);
                    document.getElementById('referrerPayout').value = referrerPayout > 0 ? '$' + referrerPayout.toFixed(2) : '0';
                    document.getElementById('netProfit').value = '$' + netProfit.toFixed(2);
                    document.getElementById('netProfit').style.color = netProfit >= 0 ? '#10b981' : '#ef4444';
                    document.getElementById('exchangeRateCalc').value = exchangeRate.toFixed(2);
                    return;
                }
                avgRate = 35; // Fallback
            }
            
            const payoutUsdt = payoutThb / avgRate;
            const profit = payinUsdt - payoutUsdt;
            const profitPercent = payoutUsdt > 0 ? (profit / payoutUsdt) * 100 : 0;
            
            // –ü–∞—Ä—Ç–Ω–µ—Ä-—Ä–µ—Ñ–µ—Ä–µ—Ä
            const referrerPercent = parseFloat(form.referrer_percent?.value) || 0;
            const referrerFixed = parseFloat(form.referrer_fixed_usdt?.value) || 0;
            let referrerPayout = 0;
            
            if (referrerPercent > 0 && profit > 0) {
                referrerPayout = profit * (referrerPercent / 100);
            } else if (referrerFixed > 0) {
                referrerPayout = referrerFixed;
            }
            
            const netProfit = profit - referrerPayout;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è
            document.getElementById('profitUsdt').value = profit.toFixed(2);
            document.getElementById('profitUsdt').placeholder = '–ê–≤—Ç–æ';
            document.getElementById('profitPercent').value = profitPercent.toFixed(1);
            document.getElementById('profitPercent').placeholder = '%';
            document.getElementById('cashBatchCostUsdt').value = '$' + payoutUsdt.toFixed(2);
            document.getElementById('referrerPayout').value = referrerPayout > 0 ? '$' + referrerPayout.toFixed(2) : '0';
            document.getElementById('netProfit').value = '$' + netProfit.toFixed(2);
            document.getElementById('netProfit').style.color = '#10b981';
        }
        
        // Auto-calculate on input change
        ['payin_amount_usdt', 'payout_amount_thb', 'referrer_percent', 'referrer_fixed_usdt'].forEach(name => {
            const el = document.querySelector(`[name="${name}"]`);
            if (el) el.addEventListener('input', calculateProfit);
        });
        document.getElementById('payoutSource')?.addEventListener('change', calculateProfit);
        document.getElementById('bankCardSelect')?.addEventListener('change', calculateProfit);
        
        document.getElementById('createDealForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                deal_type: 'pay_in',
                status: 'pending'
            };
            
            // #region agent log
            console.log('[DEBUG] Form client_name input value:', this.client_name?.value);
            // #endregion
            
            formData.forEach((value, key) => {
                // #region agent log
                if (key === 'client_name') console.log('[DEBUG] FormData client_name:', value);
                // #endregion
                if (value) {
                    if (['payin_amount_rub', 'payin_amount_thb', 'payin_amount_usdt', 
                         'payin_rate_rub_usdt', 'payout_amount_thb', 'profit_usdt', 
                         'profit_percent', 'exchange_rate'].includes(key)) {
                        data[key] = parseFloat(value);
                    } else if (key === 'client_id' || key === 'cash_batch_id') {
                        data[key] = parseInt(value) || null;
                    } else if (key === 'created_at') {
                        // –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É –¥–∞—Ç—ã, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–º–µ—â–µ–Ω–∏—è —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤
                        data[key] = value;
                    } else {
                        data[key] = value;
                    }
                }
            });
            
            // #region agent log
            console.log('[DEBUG] Final data.client_name:', data.client_name);
            // #endregion
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                const isEditMode = editingDealId !== null;
                const url = isEditMode ? `${API_URL}/api/deals/${editingDealId}` : `${API_URL}/api/deals`;
                const method = isEditMode ? 'PUT' : 'POST';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Binance –ø–æ–ª–µ–π
                if (data.payout_source === 'binance') {
                    const binanceUsdt = parseFloat(document.getElementById('binanceUsdt')?.value);
                    const binanceTxHash = document.getElementById('binanceTxInput')?.value;
                    if (binanceUsdt) data.payout_amount_usdt = binanceUsdt;
                    if (binanceTxHash) data.payout_tx_hash = binanceTxHash;
                }
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.success) {
                    alert(isEditMode ? '–°–¥–µ–ª–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!' : '–°–¥–µ–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!');
                    this.reset();
                    if (isEditMode) cancelEditMode();
                    loadDashboard();
                    loadDeals();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                console.error('Error creating/updating deal:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–¥–µ–ª–∫–∏');
            }
        });
        
        // ==================== Balance Tab Logic ====================
        function openAddWalletModal() {
            document.getElementById('addWalletModal').classList.add('active');
        }

        function closeAddWalletModal() {
            document.getElementById('addWalletModal').classList.remove('active');
        }

        document.getElementById('addWalletFormBalance').onsubmit = async function(e) {
            e.preventDefault();
            const label = document.getElementById('newWalletLabel').value;
            const address = document.getElementById('newWalletAddress').value;
            const initialBalance = parseFloat(document.getElementById('newWalletInitialBalance').value) || 0;

            try {
                // 1. –°–æ–∑–¥–∞–µ–º –∫–æ—à–µ–ª–µ–∫ (—Ç–æ–ª—å–∫–æ –¥–ª—è –±–∞–ª–∞–Ω—Å–∞)
                const response = await fetch(`${API_URL}/api/wallets`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        address: address,
                        label: label,
                        blockchain: 'TRON',
                        is_monitored: false,
                        is_balance: true
                    })
                });
                const result = await response.json();
                
                if (result.success) {
                    const walletId = result.wallet.id;
                    
                    // 2. –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å, —Å–æ–∑–¥–∞–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
                    if (initialBalance > 0) {
                        await fetch(`${API_URL}/api/wallets/${walletId}/operations`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                type: 'income',
                                amount: initialBalance,
                                description: '–ù–∞—á–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫'
                            })
                        });
                    }
                    
                    closeAddWalletModal();
                    loadWalletsSummary();
                    alert('–ö–æ—à–µ–ª–µ–∫ –¥–æ–±–∞–≤–ª–µ–Ω!');
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (e) {
                console.error(e);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ—à–µ–ª—å–∫–∞');
            }
        };

        async function deleteWalletOperation(walletId, opId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –æ–ø–µ—Ä–∞—Ü–∏—é? –ë–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω.')) return;
            try {
                const response = await fetch(`${API_URL}/api/wallets/operations/${opId}`, {
                    method: 'DELETE'
                });
                if ((await response.json()).success) {
                    showWalletHistory(walletId, '', '');
                }
            } catch (e) { console.error(e); }
        }

        let currentActiveWalletId = null;
        let currentActiveWalletAddress = null;

        function switchBalanceSubTab(tabName) {
            document.querySelectorAll('.balance-subtab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.balance-subtab-btn').forEach(b => b.classList.remove('active'));
            
            if (tabName === 'binance') {
                document.getElementById('subtabBinance').style.display = 'block';
                document.getElementById('btnSubBinance').classList.add('active');
                loadWalletsSummary();
            } else if (tabName === 'cash') {
                document.getElementById('subtabCash').style.display = 'block';
                document.getElementById('btnSubCash').classList.add('active');
                loadCashBatches();
            } else if (tabName === 'cards') {
                document.getElementById('subtabCards').style.display = 'block';
                document.getElementById('btnSubCards').classList.add('active');
                loadBankCards();
            }
        }

        async function deleteWalletFromBalance(walletId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ—à–µ–ª–µ–∫ –∏ –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π?')) return;
            try {
                const response = await fetch(`${API_URL}/api/wallets/${walletId}`, { method: 'DELETE' });
                if ((await response.json()).success) {
                    currentActiveWalletId = null;
                    document.getElementById('walletHistorySection').style.display = 'none';
                    loadWalletsSummary();
                }
            } catch (e) { console.error(e); }
        }

        async function loadWalletsSummary() {
            try {
                const response = await fetch(`${API_URL}/api/wallets/summary`);
                const data = await response.json();
                
                if (data.success) {
                    const grid = document.getElementById('walletsSummaryGrid');
                    grid.innerHTML = data.wallets.map(w => `
                        <div class="stat-card" style="cursor: pointer; position: relative; border: 2px solid ${currentActiveWalletId === w.id ? '#667eea' : '#f1f5f9'};" onclick="showWalletHistory(${w.id}, '${w.address}', '${w.label || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}')">
                            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteWalletFromBalance(${w.id})" style="position: absolute; top: 5px; right: 5px; padding: 0 5px; font-size: 0.7rem;">√ó</button>
                            <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">${w.label || '–ö–æ—à–µ–ª–µ–∫'}</div>
                            <div class="stat-value" style="font-size: 1.5rem; color: #10b981;">$${w.system_balance.toFixed(2)}</div>
                            <div style="font-family: monospace; font-size: 0.7rem; color: #999; margin-top: 0.5rem; overflow: hidden; text-overflow: ellipsis;">${w.address}</div>
                        </div>
                    `).join('');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –≤ —Ñ–æ—Ä–º–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏
                    const payoutWalletSelect = document.getElementById('payoutWalletSelect');
                    if (payoutWalletSelect) {
                        payoutWalletSelect.innerHTML = data.wallets.map(w => `<option value="${w.id}">${w.label || w.address.substring(0,8)} ($${w.system_balance.toFixed(0)})</option>`).join('');
                    }
                }
            } catch (e) { console.error('Error loading wallets summary:', e); }
        }

        async function showWalletHistory(walletId, address, label) {
            currentActiveWalletId = walletId;
            currentActiveWalletAddress = address;
            document.getElementById('walletHistorySection').style.display = 'block';
            document.getElementById('currentWalletName').textContent = `–ò—Å—Ç–æ—Ä–∏—è: ${label || address.substring(0,10)}`;
            loadWalletsSummary(); // –ß—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Ä–∞–º–∫—É –≤—ã–±–æ—Ä–∞
            
            try {
                const response = await fetch(`${API_URL}/api/wallets/${walletId}/operations`);
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('walletHistoryTable');
                    tbody.innerHTML = data.operations.map(op => `
                        <tr>
                            <td>${formatDate(op.created_at)}</td>
                            <td><span class="badge badge-${op.type === 'income' ? 'success' : 'danger'}">${op.type === 'income' ? '–ü–ª—é—Å' : '–ú–∏–Ω—É—Å'}</span></td>
                            <td style="color: ${op.type === 'income' ? '#10b981' : '#ef4444'}; font-weight: 600;">${op.type === 'income' ? '+' : '-'}$${op.amount.toFixed(2)}</td>
                            <td>
                                <div>${op.description || '-'}</div>
                                ${op.tx_hash ? `<div style="font-size: 0.75rem; font-family: monospace; color: #666;">${op.tx_hash.substring(0,20)}...</div>` : ''}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteWalletOperation(${walletId}, ${op.id})" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (e) { console.error('Error loading wallet history:', e); }
        }

        function openTopupModal() {
            if (!currentActiveWalletId) { alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫'); return; }
            document.getElementById('topupWalletId').value = currentActiveWalletId;
            document.getElementById('topupModal').classList.add('active');
            toggleTopupSource();
        }

        function closeTopupModal() { document.getElementById('topupModal').classList.remove('active'); }

        async function toggleTopupSource() {
            const type = document.getElementById('topupType').value;
            const group = document.getElementById('topupTronscanGroup');
            if (type === 'tronscan') {
                group.style.display = 'block';
                const select = document.getElementById('topupTxSelect');
                select.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
                try {
                    let url = `${API_URL}/api/transactions/incoming`;
                    if (currentActiveWalletAddress) {
                        url += `?wallet=${encodeURIComponent(currentActiveWalletAddress)}`;
                    }
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.success) {
                        select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é --</option>' + 
                            data.available.map(tx => `<option value="${tx.tx_hash}" data-amount="${tx.amount_usdt}">+$${tx.amount_usdt.toFixed(2)} | ${tx.from_address.substring(0,8)}... | ${formatDate(tx.timestamp)}</option>`).join('');
                    }
                } catch (e) { select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>'; }
            } else {
                group.style.display = 'none';
            }
        }

        function selectTopupTx() {
            const select = document.getElementById('topupTxSelect');
            const hash = select.value;
            const amount = select.selectedOptions[0]?.dataset?.amount;
            if (hash) document.getElementById('topupHash').value = hash;
            if (amount) document.getElementById('topupAmount').value = amount;
        }

        document.getElementById('topupForm').onsubmit = async function(e) {
            e.preventDefault();
            const walletId = document.getElementById('topupWalletId').value;
            const data = {
                type: 'income',
                amount: document.getElementById('topupAmount').value,
                tx_hash: document.getElementById('topupHash').value,
                description: document.getElementById('topupDesc').value || '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ'
            };
            
            try {
                const response = await fetch(`${API_URL}/api/wallets/${walletId}/operations`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if ((await response.json()).success) {
                    closeTopupModal();
                    showWalletHistory(walletId, '', '');
                }
            } catch (e) { alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏'); }
        };

        function openWithdrawModal() {
            if (!currentActiveWalletId) { alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫'); return; }
            document.getElementById('withdrawWalletId').value = currentActiveWalletId;
            document.getElementById('withdrawModal').classList.add('active');
        }

        function closeWithdrawModal() { document.getElementById('withdrawModal').classList.remove('active'); }

        document.getElementById('withdrawForm').onsubmit = async function(e) {
            e.preventDefault();
            const walletId = document.getElementById('withdrawWalletId').value;
            const data = {
                type: 'expense',
                amount: document.getElementById('withdrawAmount').value,
                description: document.getElementById('withdrawDesc').value
            };
            
            try {
                const response = await fetch(`${API_URL}/api/wallets/${walletId}/operations`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if ((await response.json()).success) {
                    closeWithdrawModal();
                    showWalletHistory(walletId, '', '');
                }
            } catch (e) { alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏'); }
        };

        // ==================== Cash Batches ====================
        async function loadCashBatches() {
            try {
                const response = await fetch(`${API_URL}/api/cash/batches`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalCashThb').textContent = formatNumber(data.summary.total_remaining_thb) + ' ‡∏ø';
                    document.getElementById('totalCashUsdt').textContent = '$' + formatNumber(data.summary.total_cost_usdt);
                    document.getElementById('avgCashRate').textContent = data.summary.weighted_avg_rate;
                    
                    document.getElementById('cashBatchesList').innerHTML = data.batches
                        .filter(b => b.status === 'active')
                        .map(batch => `
                            <div class="batch-card">
                                <div class="batch-info">
                                    <h4>–ü–∞—Ä—Ç–∏—è #${batch.id} - ${batch.founder_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</h4>
                                    <p>${batch.purchase_method || '–ë–µ–∑ –º–µ—Ç–æ–¥–∞'} | ${formatDate(batch.created_at)}</p>
                                    ${batch.tx_hash ? `<p style="font-size: 0.8rem;"><strong>–•—ç—à:</strong> <code style="cursor: pointer; background: #e0f2fe; padding: 2px 4px; border-radius: 3px; font-size: 0.75rem;" onclick="copyHash('${batch.tx_hash}')" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">${batch.tx_hash.substring(0, 20)}...</code></p>` : ''}
                                    <div class="progress">
                                        <div class="progress-bar" style="width: ${batch.used_percent}%"></div>
                                    </div>
                                    <p style="font-size: 0.8rem; color: #888; margin-top: 0.25rem;">
                                        –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: ${formatNumber(batch.used_thb)} –∏–∑ ${formatNumber(batch.amount_thb)} THB (${batch.used_percent}%)
                                    </p>
                                </div>
                                <div class="batch-amount" style="text-align: right;">
                                    <div class="thb">${formatNumber(batch.remaining_thb)} ‡∏ø</div>
                                    <div class="rate">–ö—É—Ä—Å: ${batch.purchase_rate}</div>
                                    <div style="margin-top: 0.5rem; display: flex; gap: 0.25rem; justify-content: flex-end; flex-wrap: wrap;">
                                        <button class="btn btn-sm btn-info" onclick="showBatchHistory(${batch.id})">–ò—Å—Ç–æ—Ä–∏—è</button>
                                        <button class="btn btn-sm btn-secondary" onclick="editCashBatch(${batch.id}, ${batch.remaining_thb})">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                                        ${batch.used_thb === 0 ? `
                                            <button class="btn btn-sm btn-danger" onclick="deleteCashBatch(${batch.id})">–£–¥–∞–ª–∏—Ç—å</button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('');
                }
            } catch (error) {
                console.error('Error loading cash batches:', error);
            }
        }
        
        // Calculate rate when adding batch
        document.querySelector('[name="amount_thb"]').addEventListener('input', calcNewBatchRate);
        document.querySelector('[name="cost_usdt"]').addEventListener('input', calcNewBatchRate);
        
        function calcNewBatchRate() {
            const thb = parseFloat(document.querySelector('[name="amount_thb"]').value) || 0;
            const usdt = parseFloat(document.querySelector('[name="cost_usdt"]').value) || 0;
            const rate = usdt > 0 ? (thb / usdt).toFixed(4) : '';
            document.getElementById('newBatchRate').value = rate;
        }
        
        function closeHistoryModal() {
            document.getElementById('historyModal').classList.remove('active');
        }
        
        async function showBatchHistory(batchId) {
            try {
                const response = await fetch(`${API_URL}/api/cash/batches/${batchId}/history`);
                const data = await response.json();
                
                if (data.success) {
                    const info = data.batch_info;
                    const summary = data.summary;
                    
                    document.getElementById('historyModalTitle').textContent = 
                        `–ò—Å—Ç–æ—Ä–∏—è –ø–∞—Ä—Ç–∏–∏ #${batchId} - ${info.founder_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`;
                    
                    let html = `
                        <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                                <div>
                                    <strong>–ù–∞—á–∞–ª—å–Ω–∞—è —Å—É–º–º–∞:</strong> ${formatNumber(info.amount_thb)} THB<br>
                                    <strong>–û—Å—Ç–∞—Ç–æ–∫:</strong> ${formatNumber(info.remaining_thb)} THB<br>
                                    <strong>–ö—É—Ä—Å –∑–∞–∫—É–ø–∫–∏:</strong> ${info.purchase_rate?.toFixed(2)} THB/USDT
                                </div>
                                <div style="text-align: right;">
                                    <span style="color: #666;">–°–¥–µ–ª–æ–∫: ${summary.total_deals}</span><br>
                                    <span style="color: #666;">–ö–∞—Ä—Ç: ${summary.total_card_topups}</span><br>
                                    <span style="color: #666;">–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫: ${summary.total_adjustments}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    if (data.history.length === 0) {
                        html += '<p style="color: #888; text-align: center;">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</p>';
                    } else {
                        html += '<div style="max-height: 400px; overflow-y: auto;">';
                        data.history.forEach(item => {
                            const isPositive = item.amount_thb > 0;
                            const color = isPositive ? '#10b981' : '#ef4444';
                            const sign = isPositive ? '+' : '';
                            
                            html += `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid #eee;">
                                    <div>
                                        <span style="font-size: 1.2rem; margin-right: 0.5rem;">${item.icon}</span>
                                        <strong>${item.description}</strong>
                                        <br>
                                        <small style="color: #888;">${formatDate(item.date)}</small>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="color: ${color}; font-weight: bold;">
                                            ${sign}${formatNumber(item.amount_thb)} THB
                                        </div>
                                        <small style="color: #888;">~$${item.amount_usdt?.toFixed(2) || '0'}</small>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    document.getElementById('historyModalContent').innerHTML = html;
                    document.getElementById('historyModal').classList.add('active');
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            } catch (error) {
                console.error('Error loading batch history:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏');
            }
        }
        
        async function showCardHistory(cardId) {
            try {
                const response = await fetch(`${API_URL}/api/cards/${cardId}/history`);
                const data = await response.json();
                
                if (data.success) {
                    const info = data.card_info;
                    const summary = data.summary;
                    
                    document.getElementById('historyModalTitle').textContent = 
                        `–ò—Å—Ç–æ—Ä–∏—è –∫–∞—Ä—Ç—ã: ${info.bank_name} - ${info.card_name || ''}`;
                    
                    let html = `
                        <div style="background: #eff6ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                                <div>
                                    <strong>–í–ª–∞–¥–µ–ª–µ—Ü:</strong> ${info.holder_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}<br>
                                    <strong>–ë–∞–ª–∞–Ω—Å:</strong> ${formatNumber(info.balance_thb)} THB
                                </div>
                                <div style="text-align: right;">
                                    <span style="color: #10b981;">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–π: +${formatNumber(summary.total_in)} THB</span><br>
                                    <span style="color: #ef4444;">–°–ø–∏—Å–∞–Ω–∏–π: -${formatNumber(summary.total_out)} THB</span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    if (data.history.length === 0) {
                        html += '<p style="color: #888; text-align: center;">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</p>';
                    } else {
                        html += '<div style="max-height: 400px; overflow-y: auto;">';
                        data.history.forEach(item => {
                            const isPositive = item.amount_thb > 0;
                            const color = isPositive ? '#10b981' : '#ef4444';
                            const sign = isPositive ? '+' : '';
                            
                            html += `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid #eee;">
                                    <div>
                                        <span style="font-size: 1.2rem; margin-right: 0.5rem;">${item.icon}</span>
                                        <strong>${item.description}</strong>
                                        <br>
                                        <small style="color: #888;">${formatDate(item.date)}</small>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="color: ${color}; font-weight: bold;">
                                            ${sign}${formatNumber(item.amount_thb)} THB
                                        </div>
                                        <small style="color: #888;">~$${item.amount_usdt?.toFixed(2) || '0'}</small>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    document.getElementById('historyModalContent').innerHTML = html;
                    document.getElementById('historyModal').classList.add('active');
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            } catch (error) {
                console.error('Error loading card history:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏');
            }
        }
        
        async function editCashBatch(batchId, currentRemaining) {
            const action = prompt(
                `–¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: ${formatNumber(currentRemaining)} THB\n\n` +
                `–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –∏–ª–∏ —Å—É–º–º—É –¥–ª—è –≤—ã—á–∏—Ç–∞–Ω–∏—è:\n` +
                `‚Ä¢ –ü—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ = –Ω–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 500000)\n` +
                `‚Ä¢ –ú–∏–Ω—É—Å —á–∏—Å–ª–æ = –≤—ã—á–µ—Å—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: -50000)`,
                currentRemaining
            );
            
            if (action === null) return;
            
            let newRemaining;
            const inputValue = parseFloat(action);
            
            if (isNaN(inputValue)) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ');
                return;
            }
            
            // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –º–∏–Ω—É—Å–∞ - –≤—ã—á–∏—Ç–∞–µ–º
            if (action.trim().startsWith('-')) {
                newRemaining = currentRemaining + inputValue; // inputValue —É–∂–µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π
            } else {
                newRemaining = inputValue;
            }
            
            if (newRemaining < 0) {
                alert('–û—Å—Ç–∞—Ç–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º');
                return;
            }
            
            const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏):', '–õ–∏—á–Ω—ã–µ –Ω—É–∂–¥—ã');
            if (reason === null) return;
            
            try {
                const response = await fetch(`${API_URL}/api/cash/batches/${batchId}/adjust`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        new_remaining: newRemaining,
                        reason: reason
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(`–û—Å—Ç–∞—Ç–æ–∫ –∏–∑–º–µ–Ω—ë–Ω: ${formatNumber(currentRemaining)} ‚Üí ${formatNumber(newRemaining)} THB`);
                    loadCashBatches();
                    loadDashboard();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            } catch (error) {
                console.error('Error editing batch:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∞—Ä—Ç–∏–∏');
            }
        }
        
        async function deleteCashBatch(batchId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–∞—Ä—Ç–∏—é –∫–∞—Å—Å—ã?')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/cash/batches/${batchId}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    alert('–ü–∞—Ä—Ç–∏—è —É–¥–∞–ª–µ–Ω–∞');
                    loadCashBatches();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting batch:', error);
            }
        }
        
        document.getElementById('addCashBatchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {};
            formData.forEach((value, key) => {
                if (['amount_thb', 'cost_usdt'].includes(key)) {
                    data[key] = parseFloat(value);
                } else {
                    data[key] = value;
                }
            });
            
            try {
                const response = await fetch(`${API_URL}/api/cash/batches`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('–ü–∞—Ä—Ç–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                    this.reset();
                    loadCashBatches();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                console.error('Error adding batch:', error);
            }
        });
        
        // ==================== Bank Cards ====================
        async function loadBankCards() {
            try {
                const response = await fetch(`${API_URL}/api/cards`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalCardsThb').textContent = formatNumber(data.total_remaining_thb) + ' ‡∏ø';
                    
                    const activeCards = data.cards.filter(c => c.status === 'active');
                    
                    document.getElementById('bankCardsList').innerHTML = activeCards.length > 0 
                        ? activeCards.map(card => `
                            <div class="card" style="background: #f8f9fa; padding: 1rem; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div>
                                        <h4 style="margin-bottom: 0.5rem;">${card.bank_name} - ${card.card_name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h4>
                                        <p style="color: #666; font-size: 0.9rem;">${card.holder_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'} | ${formatDate(card.created_at)}</p>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 1.25rem; font-weight: 600; color: #10b981;">${formatNumber(card.balance_thb)} ‡∏ø</div>
                                        <div style="font-size: 0.85rem; color: #666;">–°—Ä. –∫—É—Ä—Å: ${card.avg_rate || '-'}</div>
                                    </div>
                                </div>
                                
                                ${card.topups && card.topups.length > 0 ? `
                                    <div style="margin-top: 1rem; border-top: 1px solid #e5e7eb; padding-top: 0.75rem;">
                                        <p style="font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem;">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è:</p>
                                        ${card.topups.map(t => `
                                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: white; border-radius: 4px; margin-bottom: 0.25rem;">
                                                <div>
                                                    <span style="font-weight: 500;">${formatNumber(t.amount_thb)} THB</span>
                                                    <span style="color: #666; font-size: 0.85rem;">
                                                        ($${t.cost_usdt.toFixed(2)} @ ${t.purchase_rate})
                                                        ${t.source_type === 'cash_batch' ? `<span style="color: #667eea;">[–∏–∑ –∫–∞—Å—Å—ã #${t.source_batch_id}]</span>` : '<span style="color: #f59e0b;">[–æ—Ç–¥–µ–ª—å–Ω–æ]</span>'}
                                                    </span>
                                                </div>
                                                <button class="btn btn-sm btn-danger" onclick="deleteCardTopup(${card.id}, ${t.id})">√ó</button>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<p style="font-size: 0.85rem; color: #f59e0b; margin-top: 0.5rem;">–ù–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π</p>'}
                                
                                <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem;">
                                    <button class="btn btn-sm btn-info" onclick="showCardHistory(${card.id})">–ò—Å—Ç–æ—Ä–∏—è</button>
                                    ${!card.topups || card.topups.length === 0 ? `
                                        <button class="btn btn-sm btn-danger" onclick="deleteCard(${card.id})">–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç—É</button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')
                        : '<p style="color: #666;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ä—Ç</p>';
                    
                    // Load cards for topup select
                    const topupSelect = document.getElementById('topupCardSelect');
                    if (topupSelect) {
                        topupSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É</option>' +
                            activeCards.map(c => 
                                `<option value="${c.id}">${c.bank_name} - ${c.card_name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'} (${c.holder_name})</option>`
                            ).join('');
                    }
                    
                    // Load batches for source select
                    await loadCashBatchesForSelect();
                }
            } catch (error) {
                console.error('Error loading bank cards:', error);
            }
        }
        
        // Show/hide fields based on source type
        document.getElementById('topupSourceType')?.addEventListener('change', function() {
            const batchGroup = document.getElementById('topupBatchGroup');
            const costGroup = document.getElementById('topupCostGroup');
            const autoInfo = document.getElementById('topupAutoInfo');
            
            if (this.value === 'cash_batch') {
                batchGroup.style.display = 'block';
                costGroup.style.display = 'none';
                autoInfo.style.display = 'block';
                calcTopupFromBatch();
            } else {
                batchGroup.style.display = 'none';
                costGroup.style.display = 'block';
                autoInfo.style.display = 'none';
            }
        });
        
        // Calculate cost when batch or amount changes
        document.getElementById('cardSourceBatch')?.addEventListener('change', calcTopupFromBatch);
        document.getElementById('topupAmountThb')?.addEventListener('input', calcTopupFromBatch);
        
        function calcTopupFromBatch() {
            const sourceType = document.getElementById('topupSourceType')?.value;
            if (sourceType !== 'cash_batch') return;
            
            const batchSelect = document.getElementById('cardSourceBatch');
            const amountThb = parseFloat(document.getElementById('topupAmountThb')?.value) || 0;
            const autoCalc = document.getElementById('topupAutoCalc');
            
            if (!batchSelect || !autoCalc) return;
            
            const selectedOption = batchSelect.options[batchSelect.selectedIndex];
            if (!selectedOption || !selectedOption.dataset.rate) {
                autoCalc.value = '–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä—Ç–∏—é';
                return;
            }
            
            const rate = parseFloat(selectedOption.dataset.rate);
            const remaining = parseFloat(selectedOption.dataset.remaining);
            
            if (amountThb > remaining) {
                autoCalc.value = `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ! –û—Å—Ç–∞—Ç–æ–∫: ${formatNumber(remaining)} THB`;
                autoCalc.style.color = '#ef4444';
            } else if (amountThb > 0) {
                const costUsdt = amountThb / rate;
                autoCalc.value = `–ö—É—Ä—Å ${rate} ‚Üí $${costUsdt.toFixed(2)} USDT`;
                autoCalc.style.color = '#10b981';
            } else {
                autoCalc.value = `–ö—É—Ä—Å –ø–∞—Ä—Ç–∏–∏: ${rate}`;
                autoCalc.style.color = '#666';
            }
        }
        
        async function deleteCard(cardId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–∞—Ä—Ç—É? –°—Ä–µ–¥—Å—Ç–≤–∞ –≤–µ—Ä–Ω—É—Ç—Å—è –≤ –∫–∞—Å—Å—É.')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/cards/${cardId}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    alert('–ö–∞—Ä—Ç–∞ —É–¥–∞–ª–µ–Ω–∞');
                    loadBankCards();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting card:', error);
            }
        }
        
        async function deleteCardTopup(cardId, topupId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ? –ï—Å–ª–∏ –±—ã–ª–æ –∏–∑ –∫–∞—Å—Å—ã - –¥–µ–Ω—å–≥–∏ –≤–µ—Ä–Ω—É—Ç—Å—è –≤ –ø–∞—Ä—Ç–∏—é.')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/cards/${cardId}/topup/${topupId}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    alert(data.returned_to_batch 
                        ? `–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ, ${formatNumber(data.amount_returned)} THB –≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ –≤ –ø–∞—Ä—Ç–∏—é #${data.returned_to_batch}` 
                        : '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
                    loadBankCards();
                    loadCashBatchesForSelect();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting topup:', error);
            }
        }
        
        document.getElementById('addCardForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {};
            formData.forEach((value, key) => {
                if (value) data[key] = value;
            });
            
            try {
                const response = await fetch(`${API_URL}/api/cards`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('–ö–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞! –¢–µ–ø–µ—Ä—å –ø–æ–ø–æ–ª–Ω–∏—Ç–µ –µ—ë.');
                    this.reset();
                    loadBankCards();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                console.error('Error adding card:', error);
            }
        });
        
        document.getElementById('topupCardForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const cardId = formData.get('card_id');
            
            if (!cardId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É');
                return;
            }
            
            const sourceType = formData.get('source_type');
            const amountThb = parseFloat(formData.get('amount_thb'));
            
            const data = {
                amount_thb: amountThb,
                source_type: sourceType
            };
            
            if (sourceType === 'cash_batch') {
                const batchId = formData.get('source_batch_id');
                if (!batchId) {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä—Ç–∏—é –∫–∞—Å—Å—ã');
                    return;
                }
                data.source_batch_id = parseInt(batchId);
                // cost_usdt —Ä–∞—Å—Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø–æ –∫—É—Ä—Å—É –ø–∞—Ä—Ç–∏–∏
            } else {
                // –û—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–∫—É–ø–∫–∞ - –Ω—É–∂–µ–Ω cost_usdt
                const costUsdt = parseFloat(formData.get('cost_usdt'));
                if (!costUsdt) {
                    alert('–£–∫–∞–∂–∏—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ USDT');
                    return;
                }
                data.cost_usdt = costUsdt;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/cards/${cardId}/topup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('–ö–∞—Ä—Ç–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∞!');
                    this.reset();
                    loadBankCards();
                    // –û–±–Ω–æ–≤–ª—è–µ–º select –ø–∞—Ä—Ç–∏–π
                    loadCashBatchesForSelect();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                console.error('Error topping up card:', error);
            }
        });
        
        // ==================== Reimbursements ====================
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à –∏—Å—Ö–æ–¥—è—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
        let outgoingTransactionsCache = [];
        
        async function loadReimbursements() {
            // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ö–æ–¥—è—â–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            try {
                const outgoingResponse = await fetch(`${API_URL}/api/transactions/outgoing`);
                const outgoingData = await outgoingResponse.json();
                outgoingTransactionsCache = outgoingData.success ? outgoingData.available : [];
            } catch (e) {
                console.error('Error loading outgoing transactions:', e);
                outgoingTransactionsCache = [];
            }
            
            // Load pending deals by founder
            try {
                const pendingResponse = await fetch(`${API_URL}/api/reimbursements/pending`);
                const pendingData = await pendingResponse.json();
                
                if (pendingData.success && pendingData.by_founder.length > 0) {
                    document.getElementById('pendingReimbursementsList').innerHTML = pendingData.by_founder.map(founder => `
                        <div class="card" style="background: #fef3c7; margin-bottom: 1rem;">
                            <h4 style="margin-bottom: 0.5rem;">${founder.founder_name} - –æ–∂–∏–¥–∞–µ—Ç –≤–æ–∑–º–µ—â–µ–Ω–∏—è</h4>
                            <p style="color: #92400e; margin-bottom: 1rem;">
                                <strong>–í—Å–µ–≥–æ THB:</strong> ${formatNumber(founder.deals.reduce((sum, d) => sum + d.payout_amount_thb, 0))} THB 
                                (${founder.deals.length} —Å–¥–µ–ª–æ–∫)
                            </p>
                            
                            <div style="margin-bottom: 1rem;">
                                ${founder.deals.map(deal => `
                                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px; margin-bottom: 0.25rem; cursor: pointer;">
                                        <input type="checkbox" class="reimburse-deal" data-founder="${founder.founder_name}" data-deal-id="${deal.id}" data-thb="${deal.payout_amount_thb}" checked onchange="updateReimbursementTotal('${founder.founder_name}')">
                                        <span>–°–¥–µ–ª–∫–∞ #${deal.id} - ${deal.client_name}: <strong>${formatNumber(deal.payout_amount_thb)} THB</strong></span>
                                    </label>
                                `).join('')}
                            </div>
                            
                            <!-- –í—ã–±–æ—Ä –∏—Å—Ö–æ–¥—è—â–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ —Å–ø–∏—Å–∫–∞ -->
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label class="form-label">–í—ã–±—Ä–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ (–∏—Å—Ö–æ–¥—è—â–∏–µ USDT)</label>
                                <select class="form-control reimburse-tx-select" data-founder="${founder.founder_name}" onchange="selectOutgoingTx('${founder.founder_name}', this)">
                                    <option value="">-- –í—ã–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é --</option>
                                    ${outgoingTransactionsCache.map(tx => `
                                        <option value="${tx.tx_hash}" data-amount="${tx.amount_usdt}">
                                            -$${tx.amount_usdt.toFixed(2)} ‚Üí ${tx.to_address.substring(0, 10)}... | ${formatDate(tx.timestamp)}
                                        </option>
                                    `).join('')}
                                </select>
                                ${outgoingTransactionsCache.length === 0 ? '<small style="color: #666;">–î–æ–±–∞–≤—å—Ç–µ –∫–æ—à–µ–ª–µ–∫ –≤ —Ä–∞–∑–¥–µ–ª–µ "–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏" –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤</small>' : ''}
                            </div>
                            
                            <div class="form-row" style="margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">–°—É–º–º–∞ –≤–æ–∑–º–µ—â–µ–Ω–∏—è USDT *</label>
                                    <input type="number" class="form-control reimburse-amount" data-founder="${founder.founder_name}" placeholder="–°–∫–æ–ª—å–∫–æ USDT –ø–µ—Ä–µ–≤–µ–ª–∏" step="0.01" required oninput="updateReimbursementRate('${founder.founder_name}')">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">–ò—Ç–æ–≥–æ–≤—ã–π –∫—É—Ä—Å (–∞–≤—Ç–æ)</label>
                                    <input type="text" class="form-control reimburse-rate" data-founder="${founder.founder_name}" readonly placeholder="THB/USDT">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">–•—ç—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</label>
                                    <input type="text" class="form-control reimburse-tx-hash" data-founder="${founder.founder_name}" placeholder="TxHash...">
                                </div>
                            </div>
                            
                            <button class="btn btn-success reimburse-btn" data-founder="${founder.founder_name}" onclick="createReimbursement('${founder.founder_name}')">
                                –°–æ–∑–¥–∞—Ç—å –≤–æ–∑–º–µ—â–µ–Ω–∏–µ –∏ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–∏–±—ã–ª—å
                            </button>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('pendingReimbursementsList').innerHTML = 
                        '<div class="alert alert-success">–ù–µ—Ç —Å–¥–µ–ª–æ–∫ –æ–∂–∏–¥–∞—é—â–∏—Ö –≤–æ–∑–º–µ—â–µ–Ω–∏—è</div>';
                }
                
                // Load history
                const historyResponse = await fetch(`${API_URL}/api/reimbursements`);
                const historyData = await historyResponse.json();
                
                if (historyData.success && historyData.reimbursements.length > 0) {
                    document.getElementById('reimbursementsList').innerHTML = historyData.reimbursements.map(r => `
                        <div class="batch-card" style="position: relative;">
                            <div class="batch-info">
                                <h4>–í–æ–∑–º–µ—â–µ–Ω–∏–µ #${r.id} - ${r.founder_name}</h4>
                                <p>
                                    ${r.deals_count} —Å–¥–µ–ª–æ–∫ | ${formatDate(r.created_at)}<br>
                                    ${r.tx_hash ? `<code style="font-size: 0.8rem; cursor: pointer; background: #e0f2fe; padding: 2px 6px; border-radius: 4px;" onclick="copyHash('${r.tx_hash}')" title="–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">${r.tx_hash.substring(0, 25)}...</code>` : '<span style="color: #f59e0b;">–ë–µ–∑ —Ö—ç—à–∞</span>'}
                                </p>
                            </div>
                            <div class="batch-amount">
                                <div class="thb" style="color: #667eea;">$${r.amount_usdt.toFixed(2)}</div>
                                <div class="rate">${r.tx_verified ? '‚úÖ Verified' : '‚è≥'}</div>
                                <button class="btn btn-sm btn-danger" style="margin-top: 0.5rem;" onclick="deleteReimbursement(${r.id})">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('reimbursementsList').innerHTML = 
                        '<p style="color: #666;">–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –≤–æ–∑–º–µ—â–µ–Ω–∏–π</p>';
                }
                
            } catch (error) {
                console.error('Error loading reimbursements:', error);
            }
        }
        
        async function deleteReimbursement(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –≤–æ–∑–º–µ—â–µ–Ω–∏–µ?')) return;
            try {
                const response = await fetch(`${API_URL}/api/reimbursements/${id}`, { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    loadReimbursements();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting reimbursement:', error);
            }
        }
        
        async function deleteReimbursement(reimbursementId) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –≤–æ–∑–º–µ—â–µ–Ω–∏–µ #${reimbursementId}?\n\n–°–≤—è–∑–∞–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏ –≤–µ—Ä–Ω—É—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å "–æ–∂–∏–¥–∞–µ—Ç –≤–æ–∑–º–µ—â–µ–Ω–∏—è".`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/reimbursements/${reimbursementId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert(`–í–æ–∑–º–µ—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ.`);
                    loadReimbursements();
                    loadDashboard();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting reimbursement:', error);
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        function updateReimbursementTotal(founderName) {
            updateReimbursementRate(founderName);
        }
        
        function selectOutgoingTx(founderName, selectEl) {
            const txHash = selectEl.value;
            const amount = selectEl.selectedOptions[0]?.dataset?.amount;
            
            const hashInput = document.querySelector(`.reimburse-tx-hash[data-founder="${founderName}"]`);
            const amountInput = document.querySelector(`.reimburse-amount[data-founder="${founderName}"]`);
            
            if (txHash && hashInput) {
                hashInput.value = txHash;
            }
            
            if (amount && amountInput) {
                amountInput.value = amount;
                updateReimbursementRate(founderName);
            }
        }
        
        function updateReimbursementRate(founderName) {
            // –°—á–∏—Ç–∞–µ–º –æ–±—â—É—é —Å—É–º–º—É THB –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫
            const checkboxes = document.querySelectorAll(`.reimburse-deal[data-founder="${founderName}"]:checked`);
            let totalThb = 0;
            checkboxes.forEach(cb => {
                totalThb += parseFloat(cb.dataset.thb) || 0;
            });
            
            // –ü–æ–ª—É—á–∞–µ–º –≤–≤–µ–¥–µ–Ω–Ω—É—é —Å—É–º–º—É USDT
            const amountInput = document.querySelector(`.reimburse-amount[data-founder="${founderName}"]`);
            const rateInput = document.querySelector(`.reimburse-rate[data-founder="${founderName}"]`);
            
            const amountUsdt = parseFloat(amountInput?.value) || 0;
            
            if (amountUsdt > 0 && totalThb > 0) {
                const rate = totalThb / amountUsdt;
                rateInput.value = rate.toFixed(4) + ' THB/USDT';
            } else {
                rateInput.value = '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É USDT';
            }
        }
        
        // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
        const reimbursementInProgress = new Set();
        
        async function createReimbursement(founderName) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ª–∏ —É–∂–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∞—É–Ω–¥–µ—Ä–∞
            if (reimbursementInProgress.has(founderName)) {
                console.log('–ó–∞–ø—Ä–æ—Å —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–ª—è', founderName);
                return;
            }
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            const btn = document.querySelector(`.reimburse-btn[data-founder="${founderName}"]`);
            if (btn) {
                btn.disabled = true;
                btn.textContent = '–°–æ–∑–¥–∞—ë–º...';
            }
            reimbursementInProgress.add(founderName);
            
            // Get selected deals
            const checkboxes = document.querySelectorAll(`.reimburse-deal[data-founder="${founderName}"]:checked`);
            const dealIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.dealId));
            
            if (dealIds.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å–¥–µ–ª–∫—É');
                reimbursementInProgress.delete(founderName);
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = '–°–æ–∑–¥–∞—Ç—å –≤–æ–∑–º–µ—â–µ–Ω–∏–µ –∏ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–∏–±—ã–ª—å';
                }
                return;
            }
            
            const amountUsdt = parseFloat(document.querySelector(`.reimburse-amount[data-founder="${founderName}"]`)?.value);
            if (!amountUsdt || amountUsdt <= 0) {
                alert('–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É –≤–æ–∑–º–µ—â–µ–Ω–∏—è –≤ USDT');
                reimbursementInProgress.delete(founderName);
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = '–°–æ–∑–¥–∞—Ç—å –≤–æ–∑–º–µ—â–µ–Ω–∏–µ –∏ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–∏–±—ã–ª—å';
                }
                return;
            }
            
            const txHash = document.querySelector(`.reimburse-tx-hash[data-founder="${founderName}"]`)?.value;
            
            try {
                const response = await fetch(`${API_URL}/api/reimbursements`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        founder_name: founderName,
                        deal_ids: dealIds,
                        amount_usdt: amountUsdt,
                        tx_hash: txHash
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`–í–æ–∑–º–µ—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!\n\n–°—É–º–º–∞: $${result.reimbursement.amount_usdt.toFixed(2)}\n–ö—É—Ä—Å: ${result.real_rate || '-'} THB/USDT\n–ü—Ä–∏–±—ã–ª—å: $${result.total_profit?.toFixed(2) || '-'}`);
                    loadReimbursements();
                    loadDashboard();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = '–°–æ–∑–¥–∞—Ç—å –≤–æ–∑–º–µ—â–µ–Ω–∏–µ –∏ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–∏–±—ã–ª—å';
                    }
                }
            } catch (error) {
                console.error('Error creating reimbursement:', error);
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = '–°–æ–∑–¥–∞—Ç—å –≤–æ–∑–º–µ—â–µ–Ω–∏–µ –∏ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–∏–±—ã–ª—å';
                }
            } finally {
                reimbursementInProgress.delete(founderName);
            }
        }
        
        // ==================== Doverka ====================
        let incomingTxCache = [];
        
        async function loadPendingDoverka() {
            // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏–º –≤—Ö–æ–¥—è—â–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞
            try {
                const txResponse = await fetch(`${API_URL}/api/transactions/incoming`);
                const txData = await txResponse.json();
                incomingTxCache = txData.success ? txData.available : [];
            } catch (e) {
                incomingTxCache = [];
            }
            
            try {
                const response = await fetch(`${API_URL}/api/doverka/pending`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('pendingDoverkaList').innerHTML = data.deals.length > 0 
                        ? data.deals.map(deal => `
                            <div class="batch-card" style="border-left: 4px solid #f59e0b; padding: 1rem;">
                                <div class="batch-info">
                                    <h4>–°–¥–µ–ª–∫–∞ #${deal.id} - ${deal.client_name || '–ë–µ–∑ –∫–ª–∏–µ–Ω—Ç–∞'}</h4>
                                    <p>
                                        <strong>ID –î–æ–≤–µ—Ä–∫–∏:</strong> ${deal.doverka_transaction_id || '-'}<br>
                                        <strong>–°—É–º–º–∞:</strong> ${formatNumber(deal.payin_amount_rub)} ‚ÇΩ ‚Üí ${deal.payin_amount_usdt} USDT<br>
                                        <strong>–°–æ–∑–¥–∞–Ω–∞:</strong> ${formatDate(deal.created_at)}
                                    </p>
                                    
                                    <div style="margin-top: 1rem;">
                                        <label style="font-size: 0.85rem; font-weight: 500;">–í—ã–±—Ä–∞—Ç—å –≤—Ö–æ–¥—è—â—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é:</label>
                                        <select class="form-control doverka-tx-select" data-deal-id="${deal.id}" style="margin-top: 0.25rem;" onchange="selectDovekraTx(this)">
                                            <option value="">-- –í—ã–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞ --</option>
                                            ${incomingTxCache.map(tx => `
                                                <option value="${tx.tx_hash}">+$${tx.amount_usdt.toFixed(2)} | ${tx.from_address?.substring(0, 10)}... | ${formatDate(tx.timestamp)}</option>
                                            `).join('')}
                                        </select>
                                        <input type="text" class="form-control doverka-tx-hash" data-deal-id="${deal.id}" placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Ö—ç—à –≤—Ä—É—á–Ω—É—é..." style="margin-top: 0.5rem;">
                                    </div>
                                </div>
                                <div style="text-align: right; margin-top: 1rem;">
                                    <span class="badge badge-pending" style="margin-bottom: 0.5rem; display: inline-block;">–û–∂–∏–¥–∞–µ—Ç</span><br>
                                    <button class="btn btn-sm btn-success" onclick="confirmDoverka(${deal.id})">
                                        –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ
                                    </button>
                                </div>
                            </div>
                        `).join('')
                        : '<div class="alert alert-success">–ù–µ—Ç —Å–¥–µ–ª–æ–∫ –æ–∂–∏–¥–∞—é—â–∏—Ö –≤—ã–ø–ª–∞—Ç—ã –æ—Ç –î–æ–≤–µ—Ä–∫–∏</div>';
                }
            } catch (error) {
                console.error('Error loading pending doverka:', error);
            }
        }
        
        function selectDovekraTx(select) {
            const dealId = select.dataset.dealId;
            const txHash = select.value;
            const hashInput = document.querySelector(`.doverka-tx-hash[data-deal-id="${dealId}"]`);
            if (hashInput && txHash) {
                hashInput.value = txHash;
            }
        }
        
        async function confirmDoverka(dealId) {
            const hashInput = document.querySelector(`.doverka-tx-hash[data-deal-id="${dealId}"]`);
            const payoutHash = hashInput ? hashInput.value : '';
            
            try {
                const response = await fetch(`${API_URL}/api/doverka/confirm/${dealId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ payout_hash: payoutHash })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ!');
                    loadPendingDoverka();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            } catch (error) {
                console.error('Error confirming doverka:', error);
            }
        }
        
        // ==================== Transactions (TronScan) ====================
        async function loadTransactions() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—à–µ–ª—å–∫–∏
                const walletsResponse = await fetch(`${API_URL}/api/wallets`);
                const walletsData = await walletsResponse.json();
                
                const walletFilter = document.getElementById('walletFilter');
                const currentFilter = walletFilter?.value || '';

                if (walletsData.success && walletsData.wallets.length > 0) {
                    document.getElementById('walletsInfo').innerHTML = `
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            ${walletsData.wallets.map(w => `
                                <div style="padding: 0.75rem; background: #f0fdf4; border-radius: 8px; flex: 1; min-width: 200px; position: relative;">
                                    <div style="font-family: monospace; font-size: 0.8rem; color: #666; overflow: hidden; text-overflow: ellipsis;">${w.address}</div>
                                    <div style="margin-top: 0.5rem;">
                                        <strong style="color: #10b981;">$${w.usdt_balance.toFixed(2)} USDT</strong>
                                        <span style="color: #666; font-size: 0.85rem;"> | ${w.trx_balance.toFixed(2)} TRX</span>
                                    </div>
                                    <button class="btn btn-sm btn-danger" onclick="deleteWallet(${w.id})" style="position: absolute; top: 5px; right: 5px; padding: 2px 5px; font-size: 0.7rem;">√ó</button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    if (walletFilter) {
                        walletFilter.innerHTML = '<option value="">–í—Å–µ –∫–æ—à–µ–ª—å–∫–∏</option>' + 
                            walletsData.wallets.map(w => `<option value="${w.address}" ${currentFilter === w.address ? 'selected' : ''}>${w.address.substring(0, 8)}... ($${w.usdt_balance.toFixed(0)})</option>`).join('');
                    }
                } else {
                    document.getElementById('walletsInfo').innerHTML = `
                        <div class="alert alert-warning">
                            –î–æ–±–∞–≤—å—Ç–µ –∫–æ—à–µ–ª–µ–∫ TRON –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
                        </div>
                    `;
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º
                const selectedWallet = walletFilter?.value || '';
                const startDate = document.getElementById('txStartDate')?.value || '';
                const endDate = document.getElementById('txEndDate')?.value || '';
                
                let txUrl = `${API_URL}/api/transactions/incoming?`;
                if (selectedWallet) txUrl += `wallet=${encodeURIComponent(selectedWallet)}&`;
                if (startDate) txUrl += `start_date=${startDate}&`;
                if (endDate) txUrl += `end_date=${endDate}&`;

                const response = await fetch(txUrl);
                const data = await response.json();
                
                if (data.success) {
                    if (data.available.length > 0) {
                        document.getElementById('availableTransactions').innerHTML = data.available.map(tx => `
                            <div class="tx-item" style="cursor: default;">
                                <div style="flex: 1;" onclick="selectTransaction('${tx.tx_hash}', ${tx.amount_usdt}, '${tx.from_address}')" style="cursor: pointer;">
                                    <div class="tx-amount">+$${tx.amount_usdt.toFixed(2)} USDT</div>
                                    <div class="tx-hash" style="font-family: monospace; font-size: 0.8rem; color: #666; margin: 4px 0;">
                                        –û—Ç: ${tx.from_address} 
                                        <span onclick="event.stopPropagation(); copyHash('${tx.from_address}')" style="cursor: pointer; margin-left: 5px;" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å">üìã</span>
                                    </div>
                                    <div class="tx-time">
                                        ${formatDate(tx.timestamp)} | 
                                        <a href="https://tronscan.org/#/transaction/${tx.tx_hash}" target="_blank" onclick="event.stopPropagation()" style="color: #667eea; text-decoration: none;">TronScan ‚Üó</a>
                                        <span onclick="event.stopPropagation(); copyHash('${tx.tx_hash}')" style="cursor: pointer; margin-left: 5px;" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ö—ç—à">üìã</span>
                                        | ${tx.confirmed ? '‚úÖ Confirmed' : '‚è≥ Pending'}
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-success" onclick="selectTransaction('${tx.tx_hash}', ${tx.amount_usdt}, '${tx.from_address}')">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
                            </div>
                        `).join('');
                    } else {
                        document.getElementById('availableTransactions').innerHTML = data.wallets_checked?.length > 0
                            ? '<p style="color: #666; text-align: center; padding: 2rem;">–ù–µ—Ç –Ω–æ–≤—ã—Ö –≤—Ö–æ–¥—è—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</p>'
                            : '<p style="color: #f59e0b; text-align: center; padding: 2rem;">–î–æ–±–∞–≤—å—Ç–µ –∫–æ—à–µ–ª–µ–∫ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</p>';
                    }
                    
                    document.getElementById('usedTransactions').innerHTML = data.used.length > 0 
                        ? data.used.map(tx => `
                            <div class="tx-item used" style="opacity: 0.7;">
                                <div style="flex: 1;">
                                    <div class="tx-amount">$${tx.amount_usdt.toFixed(2)} USDT</div>
                                    <div class="tx-hash">${tx.tx_hash.substring(0, 30)}...</div>
                                    <div class="tx-time">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –≤ —Å–¥–µ–ª–∫–µ | ${formatDate(tx.timestamp)}</div>
                                </div>
                                <span class="badge">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</span>
                            </div>
                        `).join('')
                        : '<p style="color: #666; text-align: center; padding: 1rem;">–ù–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</p>';
                } else {
                    document.getElementById('availableTransactions').innerHTML = 
                        `<div class="alert alert-error">${data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'}</div>`;
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                document.getElementById('availableTransactions').innerHTML = 
                    '<div class="alert alert-error">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ TronScan API</div>';
            }
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞
        document.getElementById('addWalletForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            const address = this.wallet_address.value.trim();
            
            if (!address || !address.startsWith('T')) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∞–¥—Ä–µ—Å TRON –∫–æ—à–µ–ª—å–∫–∞ (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å T)');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/wallets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        address,
                        is_monitored: true,
                        is_balance: false
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(`–ö–æ—à–µ–ª–µ–∫ –¥–æ–±–∞–≤–ª–µ–Ω!\nUSDT: $${data.wallet.usdt_balance.toFixed(2)}\nTRX: ${data.wallet.trx_balance.toFixed(2)}`);
                    this.reset();
                    loadTransactions();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            } catch (error) {
                console.error('Error adding wallet:', error);
            }
        });
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        document.getElementById('verifyTxForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            const txHash = this.tx_hash.value.trim();
            
            if (!txHash) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ö—ç—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
                return;
            }
            
            document.getElementById('verifyResult').innerHTML = '<p>–ü—Ä–æ–≤–µ—Ä–∫–∞...</p>';
            
            try {
                const response = await fetch(`${API_URL}/api/transactions/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tx_hash: txHash })
                });
                const data = await response.json();
                
                if (data.success && data.found) {
                    const tx = data.transaction;
                    document.getElementById('verifyResult').innerHTML = `
                        <div style="padding: 1rem; background: #d1fae5; border-radius: 8px;">
                            <p><strong>‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞!</strong></p>
                            <p><strong>–°—É–º–º–∞:</strong> $${tx.amount_usdt?.toFixed(2) || '?'} ${tx.token || 'USDT'}</p>
                            <p><strong>–û—Ç:</strong> ${tx.from_address || '-'}</p>
                            <p><strong>–ö–æ–º—É:</strong> ${tx.to_address || '-'}</p>
                            <p><strong>–í—Ä–µ–º—è:</strong> ${formatDate(tx.timestamp)}</p>
                            <p><strong>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞:</strong> ${tx.confirmed ? '–î–∞ ‚úÖ' : '–ù–µ—Ç ‚è≥'}</p>
                            ${data.already_used ? '<p style="color: #f59e0b;"><strong>‚ö†Ô∏è –£–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –≤ —Å–¥–µ–ª–∫–µ</strong></p>' : ''}
                            ${!data.already_used && tx.amount_usdt ? `
                                <button class="btn btn-sm btn-success" style="margin-top: 0.5rem;" 
                                    onclick="selectTransaction('${tx.tx_hash}', ${tx.amount_usdt}, '${tx.from_address}')">
                                    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Å–¥–µ–ª–∫–∏
                                </button>
                            ` : ''}
                        </div>
                    `;
                } else {
                    document.getElementById('verifyResult').innerHTML = `
                        <div style="padding: 1rem; background: #fee2e2; border-radius: 8px;">
                            <p><strong>‚ùå –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</strong></p>
                            <p style="color: #666;">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ö—ç—à–∞</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error verifying transaction:', error);
                document.getElementById('verifyResult').innerHTML = 
                    '<div class="alert alert-error">–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏</div>';
            }
        });
        
        function selectTransaction(txHash, amount, fromAddress) {
            // Switch to create tab and fill data
            document.querySelector('[data-section="create"]').click();
            document.querySelector('[name="payin_tx_hash"]').value = txHash;
            document.querySelector('[name="payin_amount_usdt"]').value = amount;
            document.getElementById('payinMethod').value = 'crypto_direct';
            // Trigger change to update form
            document.getElementById('payinMethod').dispatchEvent(new Event('change'));
            
            alert(`–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤—ã–±—Ä–∞–Ω–∞!\n\n–°—É–º–º–∞: $${amount} USDT\n–û—Ç: ${fromAddress}\n\n–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è —Å–¥–µ–ª–∫–∏.`);
        }
        
        // ==================== Verification ====================
        async function loadVerificationSummary() {
            const dateFrom = document.getElementById('verifyDateFrom').value;
            const dateTo = document.getElementById('verifyDateTo').value;
            
            const params = new URLSearchParams();
            if (dateFrom) params.append('date_from', dateFrom);
            if (dateTo) params.append('date_to', dateTo);
            
            try {
                const response = await fetch(`${API_URL}/api/verification/summary?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    
                    let html = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${stats.total}</div>
                                <div class="stat-label">–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫</div>
                            </div>
                            <div class="stat-card" style="border-left: 4px solid #fef3c7;">
                                <div class="stat-value" style="color: #f59e0b;">${stats.pending}</div>
                                <div class="stat-label">–û–∂–∏–¥–∞—é—Ç</div>
                            </div>
                            <div class="stat-card" style="border-left: 4px solid #d1fae5;">
                                <div class="stat-value" style="color: #10b981;">${stats.completed}</div>
                                <div class="stat-label">–ó–∞–≤–µ—Ä—à–µ–Ω—ã</div>
                            </div>
                            <div class="stat-card" style="border-left: 4px solid #dbeafe;">
                                <div class="stat-value" style="color: #3b82f6;">${stats.verified}</div>
                                <div class="stat-label">–ü—Ä–æ–≤–µ—Ä–µ–Ω—ã</div>
                            </div>
                            <div class="stat-card success">
                                <div class="stat-value">$${stats.total_profit_usdt}</div>
                                <div class="stat-label">–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å</div>
                            </div>
                        </div>
                    `;
                    
                    if (stats.needs_attention.length > 0) {
                        html += `
                            <div class="alert alert-warning">
                                <strong>–¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è:</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem;">
                                    ${stats.needs_attention.map(item => 
                                        `<li>–°–¥–µ–ª–∫–∞ #${item.deal_id} (${item.client}): ${item.issues.join(', ')}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    if (stats.unreimbursed_founders.length > 0) {
                        html += `
                            <div class="alert alert-error">
                                <strong>–ù–µ –≤–æ–∑–º–µ—â–µ–Ω–æ —Ñ–∞—É–Ω–¥–µ—Ä–∞–º:</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem;">
                                    ${stats.unreimbursed_founders.map(item => 
                                        `<li>–°–¥–µ–ª–∫–∞ #${item.deal_id}: ${item.founder} - $${item.amount_usdt}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    if (stats.needs_attention.length === 0 && stats.unreimbursed_founders.length === 0) {
                        html += `<div class="alert alert-success">–í—Å–µ —Å–¥–µ–ª–∫–∏ –≤ –ø–æ—Ä—è–¥–∫–µ!</div>`;
                    }
                    
                    document.getElementById('verificationSummary').innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading verification:', error);
            }
        }
        
        // ==================== Webhook ====================
        async function loadWebhookConfig() {
            try {
                const response = await fetch(`${API_URL}/api/webhook/config`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('webhookUrl').value = data.webhook_url || '';
                    updateWebhookStatus(data.is_configured);
                }
            } catch (error) {
                console.error('Error loading webhook config:', error);
            }
        }
        
        function updateWebhookStatus(isConfigured) {
            const statusEl = document.getElementById('webhookStatus');
            if (isConfigured) {
                statusEl.innerHTML = '<span style="color: #10b981;">‚úì Webhook –∞–∫—Ç–∏–≤–µ–Ω</span>';
            } else {
                statusEl.innerHTML = '<span style="color: #f59e0b;">‚ö† Webhook –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</span>';
            }
        }
        
        async function saveWebhookConfig() {
            const url = document.getElementById('webhookUrl').value.trim();
            
            try {
                const response = await fetch(`${API_URL}/api/webhook/config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ webhook_url: url })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    updateWebhookStatus(!!url);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            } catch (error) {
                console.error('Error saving webhook config:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        }
        
        async function testWebhook() {
            const statusEl = document.getElementById('webhookStatus');
            statusEl.innerHTML = '<span style="color: #666;">‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è...</span>';
            
            try {
                const response = await fetch(`${API_URL}/api/webhook/test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (data.success) {
                    statusEl.innerHTML = `<span style="color: #10b981;">‚úì ${data.message}</span>`;
                } else {
                    statusEl.innerHTML = `<span style="color: #ef4444;">‚úó ${data.error}</span>`;
                }
            } catch (error) {
                console.error('Error testing webhook:', error);
                statusEl.innerHTML = '<span style="color: #ef4444;">‚úó –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</span>';
            }
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ webhook –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            loadWebhookConfig();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (1 –¥–µ–∫–∞–±—Ä—è 2025)
            const startDateInput = document.getElementById('txStartDate');
            if (startDateInput) {
                startDateInput.value = '2025-12-01';
            }
        });
        
        // ==================== Helpers ====================
        function formatNumber(num) {
            if (!num) return '0';
            return Math.round(num).toLocaleString('ru-RU');
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
        }
        
        function getStatusLabel(status) {
            const labels = {
                'pending': '–û–∂–∏–¥–∞–µ—Ç',
                'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–∞',
                'verified': '–ü—Ä–æ–≤–µ—Ä–µ–Ω–∞',
                'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–∞'
            };
            return labels[status] || status;
        }
        
        function getPayinMethodLabel(method) {
            const labels = {
                'spp_doverka': '–°–ë–ü / –î–æ–≤–µ—Ä–∫–∞',
                'partners_cash': '–ü–∞—Ä—Ç–Ω–µ—Ä—ã (–Ω–∞–ª–∏—á–Ω—ã–µ)',
                'crypto_direct': '–ö—Ä–∏–ø—Ç–∞'
            };
            return labels[method] || method || '-';
        }
        
        function getPayoutMethodLabel(method) {
            const labels = {
                'office': '–û—Ñ–∏—Å',
                'courier': '–ö—É—Ä—å–µ—Ä',
                'atm': '–ë–∞–Ω–∫–æ–º–∞—Ç',
                'transfer': '–ü–µ—Ä–µ–≤–æ–¥'
            };
            return labels[method] || method || '-';
        }
        
        function getPayoutSourceLabel(source) {
            const labels = {
                'cash_batch': '–ö–∞—Å—Å–∞',
                'bank_card': '–ö–∞—Ä—Ç–∞ –±–∞–Ω–∫–∞',
                'binance': 'Binance',
                'founder_personal': '–õ–∏—á–Ω—ã–µ —Ñ–∞—É–Ω–¥–µ—Ä–∞'
            };
            return labels[source] || source || '-';
        }
        
        // ==================== Managers ====================
        async function loadManagers() {
            try {
                const response = await fetch(`${API_URL}/api/managers`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('managersList').innerHTML = data.managers.length > 0 
                        ? data.managers.map(m => `
                            <div class="batch-card" style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4>${m.name}</h4>
                                    <small style="color: ${m.active ? '#10b981' : '#f59e0b'};">${m.active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}</small>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-sm ${m.active ? 'btn-secondary' : 'btn-success'}" onclick="toggleManager(${m.id}, ${!m.active})">
                                        ${m.active ? '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteManager(${m.id})">–£–¥–∞–ª–∏—Ç—å</button>
                                </div>
                            </div>
                        `).join('')
                        : '<p style="color: #666;">–ù–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤</p>';
                }
            } catch (error) {
                console.error('Error loading managers:', error);
            }
        }
        
        document.getElementById('addManagerForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = this.manager_name.value.trim();
            
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/managers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                const data = await response.json();
                
                if (data.success) {
                    this.reset();
                    loadManagers();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            } catch (error) {
                console.error('Error adding manager:', error);
            }
        });
        
        async function toggleManager(id, active) {
            try {
                const response = await fetch(`${API_URL}/api/managers/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ active })
                });
                const data = await response.json();
                if (data.success) loadManagers();
            } catch (error) {
                console.error('Error updating manager:', error);
            }
        }
        
        async function deleteManager(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞?')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/managers/${id}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) loadManagers();
            } catch (error) {
                console.error('Error deleting manager:', error);
            }
        }
        
        // ==================== Copy Hash Helper ====================
        function copyHash(hash) {
            navigator.clipboard.writeText(hash).then(() => {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ—Ä–æ—Ç–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                const toast = document.createElement('div');
                toast.textContent = '–•—ç—à —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!';
                toast.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #10b981; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; z-index: 10000; animation: fadeIn 0.3s;';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
            });
        }
        
        // Initial load
        loadDashboard();
    </script>
</body>
</html>
